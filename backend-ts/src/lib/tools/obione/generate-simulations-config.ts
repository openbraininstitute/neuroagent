/**
 * OBI-One Generate Simulations Config tool.
 * Translated from: backend/src/neuroagent/tools/obione_generatesimulationsconfig.py
 */

import { z } from 'zod';
import { zodToJsonSchema } from 'zod-to-json-schema';
import { BaseTool, type BaseContextVariables } from '../base-tool';
import {
  zSimulationsForm,
  zObiOneScientificUnionsAliasesSimulationsFormInitialize,
} from '../autogenerated_types/obione/zod.gen';

/**
 * Input schema for the generate simulations config tool.
 */
const GenerateSimulationsConfigInputSchema = z.object({
  circuit_id: z
    .string()
    .uuid()
    .describe('UUID of the target circuit that has to be simulated.'),
  config_request: z
    .string()
    .describe(
      "A complete description of the desired configuration that will be sent to an LLM for JSON generation. This should describe the ENTIRE configuration as it should exist after any requested changes, not just the modifications. For example, if a user says 'add X to my config' or 'remove Y from my config', translate this into a full description of what the complete configuration should contain, including all existing elements plus the requested additions or minus the requested removals."
    ),
});

/**
 * Context variables for the generate simulations config tool.
 */
export interface GenerateSimulationsConfigContextVariables extends BaseContextVariables {
  /** OpenAI client for structured output generation */
  openaiClient: any; // Type from OpenAI SDK

  /** Model to use for generation */
  model?: string;

  /** Token consumption tracking (optional) */
  tokenConsumption?: {
    model: string;
    input_tokens: number;
    output_tokens: number;
    total_tokens: number;
  } | null;
}

/**
 * Modified SimulationsForm schema without circuit reference in initialize block.
 * This is used for LLM generation, then the circuit is added back.
 */
const SimulationsFormModifiedSchema = zSimulationsForm.extend({
  initialize: zObiOneScientificUnionsAliasesSimulationsFormInitialize
    .omit({ circuit: true })
    .extend({
      circuit: z.never().optional(),
    }),
});

/**
 * Tool to generate simulation configurations using LLM.
 */
export class GenerateSimulationsConfigTool extends BaseTool<
  typeof GenerateSimulationsConfigInputSchema,
  GenerateSimulationsConfigContextVariables
> {
  static toolName = 'obione-generatesimulationsconfig';
  static toolDescription =
    'This tool generates JSON configurations for simulations based on natural language descriptions. ' +
    'It takes a user\'s request for a configuration (including modifications to existing configs) and uses an LLM with structured output to produce the corresponding JSON.\n' +
    'Always use a circuit ID with this tool. If you can\'t see a reference to an existing circuit in the chat, ask for clarifications.\n' +
    'The tool is designed to handle both new configuration requests and modifications to existing configurations. ' +
    'When users request changes like "add feature X" or "remove setting Y", the tool requires a complete description of the desired final configuration state, not just the incremental changes.\n\n' +
    'Input: A comprehensive description of the desired configuration\n' +
    'Output: Structured JSON configuration generated by an LLM\n\n' +
    'Use this tool when users need to:\n' +
    '- Create new configurations from scratch\n' +
    '- Modify existing configurations\n' +
    '- Convert configuration requirements into structured JSON format\n\n' +
    'Always call this tool to generate a simulation config, never attempt to generate one yourself.\n' +
    'Do not try to generate a simulation config yourself if the tool fails.';

  static toolNameFrontend = 'Generate Simulation Config';
  static toolDescriptionFrontend =
    'Create or modify JSON configurations using natural language.\n' +
    'Simply specify in plain english what you want your configuration to achieve or what changes you\'d like to make.';

  static utterances = [
    'Create a simulation configuration',
    'Generate a config for me',
    'Set up simulation parameters',
  ];

  override contextVariables: GenerateSimulationsConfigContextVariables;
  override inputSchema = GenerateSimulationsConfigInputSchema;

  constructor(contextVariables: GenerateSimulationsConfigContextVariables) {
    super();
    this.contextVariables = contextVariables;
  }

  /**
   * Run the tool to generate simulation configuration.
   */
  async execute(
    input: z.infer<typeof GenerateSimulationsConfigInputSchema>
  ): Promise<z.infer<typeof zSimulationsForm>> {
    const { openaiClient, model = 'gpt-4o-mini' } = this.contextVariables;

    const systemPrompt = `# Simulation Configuration Generator

You are an expert at generating valid JSON simulation configurations following the SimulationsForm schema.
The description of the required configuration is going to be the first \`user\` message you receive.
To generate a meaningful simulation config, follow these critical rules:

## Neuron Sets and References
- Generate neuron sets in the "neuron_sets" dictionary with meaningful keys
- **Only create neuron sets that will actually be used**
- For references (NeuronSetReference, TimestampsReference):
  - \`block_name\`: the dictionary key (e.g., "all_neurons")
  - \`block_dict_name\`: the parent dictionary name (e.g., "neuron_sets", "timestamps")
- Avoid duplicate or unused neuron sets unless specifically requested

## Timestamps and Stimuli Logic
- **Only generate timestamps if stimuli will use them**
- Choose stimulus type based on timing pattern:
  - **Single timestamp + MultiPulse**: For repeated pulses at one timepoint
  - **Multiple timestamps + single-pulse stimulus**: For stimuli at different timepoints
  - **Never combine MultiPulse with repetitive timestamps**

## Parameter Values
- Use single values, not single-element lists (e.g., \`"duration": 500.0\` not \`"duration": [500.0]\`)
- Lists indicate parameter sweeps - only use when scanning multiple values
- For IDNeuronSet, include meaningful number of neurons (typically 50+ for populations)

## Validation Checklist
Before outputting, verify:
- [ ] All references use existing dictionary keys with correct block_dict_name
- [ ] No unused neuron sets or timestamps
- [ ] Stimulus timing logic is coherent
- [ ] No single-element lists unless intentional parameter sweep

Generate only the JSON configuration, ensuring all references are internally consistent.`;

    try {
      // Convert Zod schema to JSON Schema for OpenAI
      const jsonSchema = zodToJsonSchema(SimulationsFormModifiedSchema, {
        name: 'SimulationsForm',
      });

      // Call OpenAI with structured output
      const response = await openaiClient.chat.completions.create({
        model,
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: input.config_request },
        ],
        response_format: {
          type: 'json_schema',
          json_schema: {
            name: 'SimulationsForm',
            schema: jsonSchema,
            strict: true,
          },
        },
      });

      const content = response.choices[0]?.message?.content;
      if (!content) {
        throw new Error("Couldn't generate a valid simulation config.");
      }

      // Parse the generated config
      const generatedConfig = JSON.parse(content);

      // Validate with Zod schema (without circuit)
      const validatedConfig = SimulationsFormModifiedSchema.parse(generatedConfig);

      // Add the circuit reference back
      const outputConfig: z.infer<typeof zSimulationsForm> = {
        type: 'SimulationsForm',
        timestamps: validatedConfig.timestamps || {},
        stimuli: validatedConfig.stimuli || {},
        recordings: validatedConfig.recordings || {},
        neuron_sets: validatedConfig.neuron_sets || {},
        synaptic_manipulations: validatedConfig.synaptic_manipulations || {},
        initialize: {
          type: 'SimulationsForm.Initialize',
          circuit: {
            type: 'CircuitFromID',
            id_str: input.circuit_id,
          },
          ...validatedConfig.initialize,
        },
        info: validatedConfig.info,
      };

      // Track token consumption if available
      if (response.usage && this.contextVariables.tokenConsumption !== undefined) {
        this.contextVariables.tokenConsumption = {
          model,
          input_tokens: response.usage.prompt_tokens || 0,
          output_tokens: response.usage.completion_tokens || 0,
          total_tokens: response.usage.total_tokens || 0,
        };
      }

      return outputConfig;
    } catch (error) {
      if (error instanceof Error) {
        throw new Error(
          `Failed to generate simulation config: ${error.message}`
        );
      }
      throw error;
    }
  }

  /**
   * Check if the tool is online.
   */
  static async isOnline(): Promise<boolean> {
    // This tool is always online as it only depends on OpenAI
    return true;
  }
}
