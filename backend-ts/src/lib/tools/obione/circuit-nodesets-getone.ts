/**
 * OBI-One circuit nodesets tool.
 * Translated from: backend/src/neuroagent/tools/obione_circuitnodesets_getone.py
 */

import { z } from 'zod';
import { type KyInstance } from 'ky';
import { BaseTool, type BaseContextVariables } from '../base-tool';
import {
  zCircuitNodesetsEndpointDeclaredCircuitCircuitIdNodesetsGetData,
  zCircuitNodesetsResponse,
} from '../autogenerated_types/obione/zod.gen';

/**
 * Input schema for the circuit nodesets tool.
 * Extends the autogenerated schema with overridden field descriptions.
 */
const CircuitNodesetsGetOneInputSchema =
  zCircuitNodesetsEndpointDeclaredCircuitCircuitIdNodesetsGetData.shape.path.extend({
    circuit_id: z
      .string()
      .uuid()
      .describe('ID of the circuit from which the nodesets should be retrieved.'),
  });

/**
 * Context variables for the circuit nodesets tool.
 */
export interface ObiOneContextVariables extends BaseContextVariables {
  /** HTTP client (ky instance) pre-configured with JWT token */
  httpClient: KyInstance;

  /** OBI-One API base URL */
  obiOneUrl: string;

  /** Virtual lab ID (optional) */
  vlabId?: string;

  /** Project ID (optional) */
  projectId?: string;
}

/**
 * Tool to get the circuit nodesets.
 */
export class CircuitNodesetsGetOneTool extends BaseTool<
  typeof CircuitNodesetsGetOneInputSchema,
  ObiOneContextVariables
> {
  static toolName = 'obione-circuitnodesets-getone';
  static toolDescription =
    'Given a circuit ID, retrieve the nodesets of it.';

  static toolNameFrontend = 'Get Circuit Nodesets';
  static toolDescriptionFrontend =
    'Retrieve the nodesets data for a circuit, and get insights into its composition.';

  static utterances = [
    'Get the circuit nodesets',
    'Retrieve nodesets data for this circuit',
    'Show me the nodesets of this circuit',
  ];

  override contextVariables: ObiOneContextVariables;
  override inputSchema = CircuitNodesetsGetOneInputSchema;

  constructor(contextVariables: ObiOneContextVariables) {
    super();
    this.contextVariables = contextVariables;
  }

  /**
   * Run the circuit nodesets retrieval.
   */
  async execute(
    input: z.infer<typeof CircuitNodesetsGetOneInputSchema>
  ): Promise<z.infer<typeof zCircuitNodesetsResponse>> {
    const { obiOneUrl, vlabId, projectId, httpClient } = this.contextVariables;

    // Prepare headers
    const headers: Record<string, string> = {};
    if (vlabId) {
      headers['virtual_lab_id'] = vlabId;
    }
    if (projectId) {
      headers['project_id'] = projectId;
    }

    try {
      const response = await httpClient
        .get(`${obiOneUrl}/declared/circuit/${input.circuit_id}/nodesets`, {
          headers,
        })
        .json();

      // Validate response with Zod schema
      return zCircuitNodesetsResponse.parse(response);
    } catch (error) {
      if (error instanceof Error) {
        throw new Error(
          `The circuit nodesets endpoint returned a non 200 response code. Error: ${error.message}`
        );
      }
      throw error;
    }
  }

  /**
   * Check if the tool is online.
   */
  static async isOnline(contextVariables: ObiOneContextVariables): Promise<boolean> {
    try {
      const { obiOneUrl, httpClient } = contextVariables;
      const healthUrl = `${obiOneUrl.replace(/\/$/, '')}/health`;

      await httpClient.get(healthUrl);
      return true;
    } catch {
      return false;
    }
  }
}
