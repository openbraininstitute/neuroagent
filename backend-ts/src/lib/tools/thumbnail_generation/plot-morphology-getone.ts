/**
 * Get One Morphology Thumbnail tool.
 * Translated from: backend/src/neuroagent/tools/thumbnailgen_morphology_getone.py
 */

import { z } from 'zod';
import { HTTPError } from 'ky';
import { BaseTool } from '../base-tool';
import { ThumbnailGenerationContextVariables } from './types';
import { zGetMorphologyPreviewApiThumbnailGenerationCoreCellMorphologyPreviewGetData } from '../autogenerated_types/thumbnail_generation/zod.gen';
import { saveToStorage } from './storage';

/**
 * Input schema for the Plot Morphology tool.
 * Extends the autogenerated schema, excluding asset_id (fetched internally).
 */
const PlotMorphologyGetOneInputSchema =
  zGetMorphologyPreviewApiThumbnailGenerationCoreCellMorphologyPreviewGetData.shape.query
    .omit({ asset_id: true })
    .extend({
      entity_id: z
        .string()
        .uuid()
        .describe('ID of the target morphology entity.'),
      dpi: z
        .number()
        .int()
        .gte(10)
        .lte(600)
        .optional()
        .describe('DPI for the generated image.'),
    });

/**
 * Output schema for the Plot Morphology tool.
 */
const PlotMorphologyGetOneOutputSchema = z.object({
  storage_id: z
    .string()
    .describe('Identifier for where the generated plot is stored.'),
});

/**
 * Tool to generate a visual representation of a morphology.
 */
export class PlotMorphologyGetOneTool extends BaseTool<
  typeof PlotMorphologyGetOneInputSchema,
  ThumbnailGenerationContextVariables
> {
  static toolName = 'thumbnail-generation-morphology-getone';
  static toolNameFrontend = 'Get Morphology Thumbnail';

  static toolDescription = `**Purpose**:
Generate a visual representation of a specified morphology.

**When to Call**:
When the user asks to plot a morphology or requests more information about a morphology.

**Inputs**:
entity_id: ID of the target entity.

**Output**:
storage_id: Identifier for where the generated plot is stored.

**Notes**:
Do not embed or display the plot link directly in your response.`;

  static toolDescriptionFrontend = `Plot the morphology of your choice to display a thumbnail in the chat.

Use this tool to enhance the description of your target morphology by adding visuals.`;

  static toolUtterances = [
    'Create a visual representation',
    'Generate a thumbnail for this morphology',
    'Show me a visualization of this morphology',
  ];

  override contextVariables: ThumbnailGenerationContextVariables;
  override inputSchema = PlotMorphologyGetOneInputSchema;

  constructor(contextVariables: ThumbnailGenerationContextVariables) {
    super();
    this.contextVariables = contextVariables;
  }

  /**
   * Execute the tool to generate a morphology thumbnail.
   *
   * @param input - Tool input containing entity_id and optional dpi
   * @returns Object containing the storage_id where the plot is stored
   */
  async execute(
    input: z.infer<typeof PlotMorphologyGetOneInputSchema>
  ): Promise<z.infer<typeof PlotMorphologyGetOneOutputSchema>> {
    const {
      httpClient,
      entitycoreUrl,
      thumbnailGenerationUrl,
      s3Client,
      bucketName,
      userId,
      threadId,
      vlabId,
      projectId,
    } = this.contextVariables;

    // Prepare headers
    const headers: Record<string, string> = {};
    if (vlabId) {
      headers['virtual-lab-id'] = vlabId;
    }
    if (projectId) {
      headers['project-id'] = projectId;
    }

    try {
      // Retrieve the asset_id from the entity_id
      const cellMorphologyResponse = await httpClient.get(
        `${entitycoreUrl.replace(/\/$/, '')}/cell-morphology/${input.entity_id}`,
        { headers }
      );

      const cellMorphology = (await cellMorphologyResponse.json()) as any;
      const assets = cellMorphology.assets;

      if (!assets || !Array.isArray(assets)) {
        throw new Error(
          `No assets found for cell morphology ${input.entity_id}`
        );
      }

      // Get the swc asset
      const swcAsset = assets.find(
        (asset: any) => asset.content_type === 'application/swc'
      );

      if (!swcAsset) {
        throw new Error(
          `No SWC asset found for the cell morphology ${input.entity_id}`
        );
      }

      // Prepare query parameters
      const queryParams: Record<string, string> = {
        entity_id: input.entity_id,
        asset_id: swcAsset.id,
      };

      if (input.dpi !== undefined) {
        queryParams['dpi'] = input.dpi.toString();
      }

      // Request thumbnail generation
      const thumbnailResponse = await httpClient.get(
        `${thumbnailGenerationUrl.replace(/\/$/, '')}/core/cell-morphology/preview`,
        {
          headers,
          searchParams: queryParams,
        }
      );

      // Get the image content as buffer
      const imageBuffer = await thumbnailResponse.arrayBuffer();

      // Save to storage
      const storageId = await saveToStorage(
        s3Client,
        bucketName,
        userId,
        'image/png',
        'image',
        Buffer.from(imageBuffer),
        threadId
      );

      return { storage_id: storageId };
    } catch (error) {
      if (error instanceof HTTPError) {
        const errorText = await error.response.text();
        throw new Error(
          `The Cell Morphology endpoint returned a non-200 response code. Error: ${errorText}`
        );
      }
      throw error;
    }
  }

  /**
   * Check if the thumbnail generation service is online.
   *
   * @param contextVariables - Context variables containing httpClient and thumbnailGenerationUrl
   * @returns True if the service is online, false otherwise
   */
  static async isOnline(
    contextVariables: ThumbnailGenerationContextVariables
  ): Promise<boolean> {
    try {
      const { httpClient, thumbnailGenerationUrl } = contextVariables;
      const healthUrl = `${thumbnailGenerationUrl.replace(/\/$/, '')}/health`;

      await httpClient.get(healthUrl);
      return true;
    } catch {
      return false;
    }
  }
}
