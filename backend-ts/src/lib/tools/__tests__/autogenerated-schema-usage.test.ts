/**
 * Property Test: Autogenerated Schema Usage
 *
 * **Property 28: Autogenerated Schema Usage**
 * **Validates: Requirements 18.1-18.3, 18.12**
 *
 * Tests that API-based tools use autogenerated Zodios schemas from OpenAPI specifications.
 *
 * This property test verifies that:
 * 1. EntityCore tools use autogenerated schemas from entitycore OpenAPI spec
 * 2. OBIOne tools use autogenerated schemas from obione OpenAPI spec
 * 3. Thumbnail Generation tools use autogenerated schemas from thumbnail_generation OpenAPI spec
 * 4. Tools don't manually redefine schemas that should be autogenerated
 * 5. Autogenerated schemas are properly imported and used for validation
 */

import { describe, it, expect } from 'vitest';
import { readFileSync } from 'fs';
import { join } from 'path';

describe('Property 28: Autogenerated Schema Usage', () => {
  describe('EntityCore Tools Use Autogenerated Schemas', () => {
    it('should import schemas from autogenerated entitycore types', async () => {
      // Read the brain-region-getall tool source
      const toolPath = join(
        __dirname,
        '../entitycore/brain-region-getall.ts'
      );
      const toolSource = readFileSync(toolPath, 'utf-8');

      // Verify it imports from autogenerated types (actual path without .ts extension)
      expect(toolSource).toContain("from '../autogenerated_types/entitycore/zod.gen'");

      // Verify it uses autogenerated schemas (not manually defined)
      expect(toolSource).toContain('zListResponseBrainRegionRead');
      expect(toolSource).toContain('zReadManyBrainRegionGetData');
    });

    it('should use autogenerated schemas for all EntityCore GetAll tools', async () => {
      const tools = [
        'brain-region-getall',
        'brain-atlas-getall',
        'cell-morphology-getall',
      ];

      for (const toolName of tools) {
        const toolPath = join(__dirname, `../entitycore/${toolName}.ts`);
        const toolSource = readFileSync(toolPath, 'utf-8');

        // Verify autogenerated import
        expect(toolSource).toContain(
          "from '../autogenerated_types/entitycore/zod.gen'"
        );

        // Verify uses zListResponse pattern (autogenerated)
        expect(toolSource).toMatch(/zListResponse\w+Read/);
      }
    });

    it('should use autogenerated schemas for all EntityCore GetOne tools', async () => {
      const tools = [
        'brain-region-getone',
        'brain-atlas-getone',
        'cell-morphology-getone',
      ];

      for (const toolName of tools) {
        const toolPath = join(__dirname, `../entitycore/${toolName}.ts`);
        const toolSource = readFileSync(toolPath, 'utf-8');

        // Verify autogenerated import
        expect(toolSource).toContain(
          "from '../autogenerated_types/entitycore/zod.gen'"
        );

        // Verify uses autogenerated schemas (check for schema names starting with 'z')
        // These tools use various patterns: zReadOne...GetData, zReadOne...GetResponse, z...Read
        const hasAutogeneratedSchema =
          toolSource.includes('zReadOne') ||
          toolSource.includes('zBrainRegionRead') ||
          toolSource.includes('zBrainAtlasRead') ||
          toolSource.includes('zCellMorphologyRead') ||
          toolSource.match(/z[A-Z]\w+Read/);

        expect(hasAutogeneratedSchema).toBeTruthy();
      }
    });
  });

  describe('OBIOne Tools Use Schemas', () => {
    it('should define schemas for circuit metric tool', async () => {
      const toolPath = join(__dirname, '../obione/circuit-metric-getone.ts');
      const toolSource = readFileSync(toolPath, 'utf-8');

      // Verify it defines schemas
      expect(toolSource).toContain('zCircuitMetricsOutput');
    });

    it('should define schemas for all OBIOne tools', async () => {
      const tools = [
        'circuit-metric-getone',
        'circuit-nodesets-getone',
        'circuit-population-getone',
        'ephys-metrics-getone',
        'morphometrics-getone',
      ];

      for (const toolName of tools) {
        const toolPath = join(__dirname, `../obione/${toolName}.ts`);
        const toolSource = readFileSync(toolPath, 'utf-8');

        // Verify it uses autogenerated schemas from obione
        expect(toolSource).toContain(
          "from '../autogenerated_types/obione/zod.gen'"
        );

        // Verify it uses autogenerated output schemas (pattern: z...Output or z...Response)
        expect(toolSource).toMatch(/z\w+(Output|Response)/);
      }
    });
  });

  describe('Thumbnail Generation Tools Use Autogenerated Schemas', () => {
    it('should use autogenerated schemas for plot morphology tool', async () => {
      const toolPath = join(
        __dirname,
        '../thumbnail_generation/plot-morphology-getone.ts'
      );
      const toolSource = readFileSync(toolPath, 'utf-8');

      // Verify it imports from autogenerated types
      expect(toolSource).toContain(
        "from '../autogenerated_types/thumbnail_generation/zod.gen'"
      );

      // Verify it uses autogenerated schemas
      expect(toolSource).toMatch(/zGet\w+GetData/);
    });

    it('should use autogenerated schemas for plot electrical recording tool', async () => {
      const toolPath = join(
        __dirname,
        '../thumbnail_generation/plot-electrical-cell-recording-getone.ts'
      );
      const toolSource = readFileSync(toolPath, 'utf-8');

      // Verify it imports from autogenerated types
      expect(toolSource).toContain(
        "from '../autogenerated_types/thumbnail_generation/zod.gen'"
      );

      // Verify it uses autogenerated schemas
      expect(toolSource).toMatch(/zGet\w+GetData/);
    });
  });

  describe('Schema Extension Patterns', () => {
    it('should extend autogenerated schemas rather than redefine them', async () => {
      const toolPath = join(__dirname, '../entitycore/brain-region-getall.ts');
      const toolSource = readFileSync(toolPath, 'utf-8');

      // Verify it uses .shape.query pattern to extract query params
      expect(toolSource).toContain('.shape.query');

      // Verify it uses .extend() to add custom validation
      expect(toolSource).toContain('.extend(');

      // Verify it uses .omit() to exclude fields
      expect(toolSource).toContain('.omit(');
    });

    it('should use .unwrap() when dealing with optional wrappers', async () => {
      const toolPath = join(__dirname, '../entitycore/brain-region-getall.ts');
      const toolSource = readFileSync(toolPath, 'utf-8');

      // Verify it uses .unwrap() to remove optional wrapper
      expect(toolSource).toContain('.unwrap()');
    });
  });

  describe('No Manual Schema Redefinition', () => {
    it('should not manually define ListResponse schemas', async () => {
      const tools = [
        'brain-region-getall',
        'cell-morphology-getall',
        'brain-atlas-getall',
      ];

      for (const toolName of tools) {
        const toolPath = join(__dirname, `../entitycore/${toolName}.ts`);
        const toolSource = readFileSync(toolPath, 'utf-8');

        // Should NOT manually define ListResponse
        expect(toolSource).not.toContain('const ListResponse = z.object');
        expect(toolSource).not.toContain('const ListResponseSchema = z.object');

        // Should use autogenerated zListResponse
        expect(toolSource).toMatch(/zListResponse\w+Read/);
      }
    });

    it('should not manually define entity read schemas', async () => {
      const tools = [
        'brain-region-getone',
        'cell-morphology-getone',
        'brain-atlas-getone',
      ];

      for (const toolName of tools) {
        const toolPath = join(__dirname, `../entitycore/${toolName}.ts`);
        const toolSource = readFileSync(toolPath, 'utf-8');

        // Should NOT manually define entity schemas
        expect(toolSource).not.toContain('const BrainRegionRead = z.object');
        expect(toolSource).not.toContain('const CellMorphologyRead = z.object');
        expect(toolSource).not.toContain('const BrainAtlasRead = z.object');

        // Should import from autogenerated types
        expect(toolSource).toContain("from '../autogenerated_types/entitycore/zod.gen'");
      }
    });
  });

  describe('Schema Import Consistency', () => {
    it('should consistently import from autogenerated_types directory', async () => {
      const entitycoreTools = [
        'brain-region-getall',
        'brain-region-getone',
        'cell-morphology-getall',
        'cell-morphology-getone',
      ];

      for (const toolName of entitycoreTools) {
        const toolPath = join(__dirname, `../entitycore/${toolName}.ts`);
        const toolSource = readFileSync(toolPath, 'utf-8');

        // All EntityCore tools should import from the same autogenerated path
        expect(toolSource).toContain(
          "from '../autogenerated_types/entitycore/zod.gen'"
        );
      }
    });

    it('should use consistent import patterns across tool types', async () => {
      // EntityCore tools
      const entitycorePath = join(__dirname, '../entitycore/brain-region-getall.ts');
      const entitycoreSource = readFileSync(entitycorePath, 'utf-8');
      expect(entitycoreSource).toContain("from '../autogenerated_types/entitycore/zod.gen'");

      // Thumbnail Generation tools
      const thumbnailPath = join(
        __dirname,
        '../thumbnail_generation/plot-morphology-getone.ts'
      );
      const thumbnailSource = readFileSync(thumbnailPath, 'utf-8');
      expect(thumbnailSource).toContain(
        "from '../autogenerated_types/thumbnail_generation/zod.gen'"
      );
    });
  });
});
