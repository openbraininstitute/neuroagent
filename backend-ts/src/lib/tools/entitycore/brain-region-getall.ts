/**
 * Brain Region GetAll Tool
 *
 * Translated from backend/src/neuroagent/tools/entitycore_brainregion_getall.py
 *
 * Searches a neuroscience based knowledge graph to retrieve brain regions.
 */

import { z } from 'zod';

import { BaseTool, type EntitycoreContextVariables } from '../base-tool';
import {
  zReadManyBrainRegionGetData,
  zListResponseBrainRegionRead,
} from '../autogenerated_types/entitycore/zod.gen';

/**
 * Input schema for Brain Region GetAll tool
 *
 * Extends the autogenerated query schema with custom overrides:
 * - Excludes name-based parameters to encourage semantic search usage
 * - Restricts page_size to 1-10 (default 5) instead of default 100
 * - Sets hierarchy_id to specific enum values with default
 * - Enhances semantic_search description
 *
 * Equivalent to Python's BrainRegionGetAllInput which extends
 * EntitycoreExcludeNameParams and ReadManyBrainRegionGetParametersQuery
 */
const BrainRegionGetAllInputSchema = zReadManyBrainRegionGetData.shape.query
  .unwrap() // Remove optional wrapper
  .extend({
    // Override page_size with stricter constraints
    page_size: z
      .number()
      .int()
      .gte(1)
      .lte(10)
      .default(5)
      .describe('Number of items per page (1-10)'),

    // Override hierarchy_id with specific enum and default
    hierarchy_id: z
      .enum(['e3e70682-c209-4cac-a29f-6fbed82c07cd', 'e3fdfcc0-6807-4be1-aefc-b3f9116f6ced'])
      .default('e3e70682-c209-4cac-a29f-6fbed82c07cd')
      .describe(
        'The hierarchy ID for brain regions. The default value is the most commonly used hierarchy ID called "aibs". The second one is: "Julich-Brain Probabilistic Cytoarchitectonic Atlas".'
      ),

    // Override semantic_search with enhanced description
    semantic_search: z
      .string()
      .optional()
      .describe(
        'Perform semantic search to find brain regions by their names. Enter any text related to a brain region name (e.g., "hippocampus", "frontal cortex", "amygdala") and receive results ranked by semantic similarity to your query.'
      ),
  })
  .omit({
    // Exclude name-based parameters (EntitycoreExcludeNameParams pattern)
    name: true,
    name__in: true,
    name__ilike: true,
  });

/**
 * Brain Region GetAll Tool
 *
 * Searches and retrieves brain regions from the EntityCore knowledge graph.
 * Supports semantic search and various filtering options.
 */
export class BrainRegionGetAllTool extends BaseTool<
  typeof BrainRegionGetAllInputSchema,
  EntitycoreContextVariables
> {
  // Static properties (tool metadata)
  static readonly toolName = 'entitycore-brainregion-getall';
  static readonly toolNameFrontend = 'Get All Brain Regions';
  static readonly toolDescription = `Searches a neuroscience based knowledge graph to retrieve brain regions.
The output is a list of brain regions, containing:
- The brain region ID
- The brain region name
- The brain region acronym
- The brain region annotation value
- The brain region color hex triplet
- The brain region hierarchy information

Note: The \`semantic_search\` parameter will always return results even for irrelevant queries - critically evaluate whether returned brain regions are actually related to your search terms.`;
  static readonly toolDescriptionFrontend = `Search and retrieve brain regions. Use this tool to:
• Find brain regions by name or acronym
• Access detailed brain region data
• Filter brain regions by various criteria

Specify optional criteria to find relevant brain regions.`;
  static readonly toolUtterances = [
    'Find a morphology in the isocortex and give me its features.',
    'Find brain regions.',
    'Show me available brain regions.',
    'What brain regions are there?',
    'Find an electrical recording in the thalamus and make an in depth analysis of it.',
    'Are there circuits in the sscx ?',
    'Find all of the thalamical neurons.',
  ];
  static readonly toolHil = false;

  override contextVariables: EntitycoreContextVariables;
  override inputSchema = BrainRegionGetAllInputSchema;

  constructor(contextVariables: EntitycoreContextVariables) {
    super();
    this.contextVariables = contextVariables;
  }

  /**
   * Execute the brain region search
   *
   * @param input - Validated search parameters
   * @returns List of brain regions with pagination
   */
  async execute(
    input: z.infer<typeof BrainRegionGetAllInputSchema>
  ): Promise<z.infer<typeof zListResponseBrainRegionRead>> {
    const { entitycoreUrl, vlabId, projectId, httpClient } = this.contextVariables;

    // Prepare query parameters using URLSearchParams
    const searchParams = new URLSearchParams();
    Object.entries(input).forEach(([key, value]) => {
      if (value !== undefined) {
        if (Array.isArray(value)) {
          value.forEach((v) => searchParams.append(key, String(v)));
        } else {
          searchParams.set(key, String(value));
        }
      }
    });

    // Prepare headers
    const headers: Record<string, string> = {};
    if (vlabId) {
      headers['virtual-lab-id'] = vlabId;
    }
    if (projectId) {
      headers['project-id'] = projectId;
    }

    try {
      const url = `${entitycoreUrl.replace(/\/$/, '')}/brain-region`;

      // Use ky's built-in JSON parsing and error handling
      const data = await httpClient
        .get(url, {
          searchParams,
          headers,
        })
        .json();

      // Validate response with Zod schema
      const validated = zListResponseBrainRegionRead.parse(data);
      return validated;
    } catch (error: any) {
      throw new Error(
        `The brain-region endpoint returned an error: ${error.message || JSON.stringify(error)}`
      );
    }
  }

  /**
   * Static health check method (classmethod equivalent)
   *
   * @param contextVariables - Context variables with API configuration
   * @returns True if the service is online
   */
  static async isOnline(contextVariables: EntitycoreContextVariables): Promise<boolean> {
    try {
      const { entitycoreUrl, httpClient } = contextVariables;
      const healthUrl = `${entitycoreUrl.replace(/\/$/, '')}/health`;

      await httpClient.get(healthUrl);
      return true;
    } catch {
      return false;
    }
  }
}
