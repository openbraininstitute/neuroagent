# MinIO Presigned URL Fix for AWS SDK v3

## Issue

Thumbnail images generated by the TypeScript backend were not loading in the frontend, even though:
- The tool execution succeeded
- Files were uploaded to MinIO successfully
- The presigned URL endpoint returned a URL

## Root Cause

AWS SDK for JavaScript v3 has a known issue with MinIO when using non-standard ports (like `:9000`). The SDK can incorrectly handle the endpoint URL when generating presigned URLs, leading to signature mismatches or incorrect URLs.

**Reference**: https://github.com/minio/minio/discussions/14709

## Solution

### 1. S3 Client Configuration (`src/lib/storage/client.ts`)

Added `disableHostPrefix: true` to the S3Client configuration:

```typescript
s3ClientInstance = new S3Client({
  endpoint: endpointUrl,
  region: 'us-east-1',
  credentials: { ... },
  forcePathStyle: true,
  disableHostPrefix: true, // Critical for MinIO with non-standard ports
});
```

**Why this works**:
- `disableHostPrefix: true` prevents the SDK from modifying the endpoint URL
- Ensures the endpoint is used exactly as provided, including the port number
- Required for MinIO compatibility when using ports other than 80/443

### 2. Presigned URL Generation (`src/app/api/storage/[file_identifier]/presigned-url/route.ts`)

Added explicit signature configuration:

```typescript
const presignedUrl = await getSignedUrl(s3Client, command, {
  expiresIn: settings.storage.expiresIn || 600,
  signableHeaders: new Set(['host']), // Ensure signature version 4
});
```

**Why this works**:
- Explicitly specifies which headers to include in the signature
- Ensures AWS Signature Version 4 is used (required by MinIO)
- Provides consistent signature generation across different SDK versions

## Verification

1. **Tests Pass**: All 11 thumbnail generation tests pass
2. **Tool Execution**: Tools successfully upload images to MinIO
3. **Presigned URLs**: Generated URLs should now work correctly with MinIO

## Testing the Fix

### 1. Generate a Thumbnail

Use the chat interface to generate a thumbnail:
```
"Show me a morphology thumbnail for entity {entity_id}"
```

### 2. Check Tool Response

The tool should return:
```json
{
  "storage_id": "uuid-here"
}
```

### 3. Get Presigned URL

Call the endpoint:
```bash
curl -H "Authorization: Bearer YOUR_JWT" \
  http://localhost:3000/api/storage/{storage_id}/presigned-url
```

Should return a URL like:
```
http://localhost:9000/neuroagent/{user_id}/{storage_id}?X-Amz-Algorithm=AWS4-HMAC-SHA256&...
```

### 4. Verify Image Loads

- Open the presigned URL in a browser - image should display
- Check the frontend - thumbnail should appear in the chat

## Comparison with Python Backend

### Python (boto3)
```python
presigned_url = s3_client.generate_presigned_url(
    "get_object",
    Params={"Bucket": bucket_name, "Key": key},
    ExpiresIn=expires_in,
)
```

### TypeScript (AWS SDK v3)
```typescript
const presignedUrl = await getSignedUrl(s3Client, command, {
  expiresIn: expiresIn,
  signableHeaders: new Set(['host']),
});
```

Both now generate compatible presigned URLs that work with MinIO.

## Known Issues with AWS SDK v3 and MinIO

1. **Port Handling**: SDK v3 can ignore or incorrectly handle port numbers in endpoints
2. **Signature Calculation**: Different signature calculation between v2 and v3
3. **Host Header**: Inconsistent host header handling for non-AWS endpoints

## Workarounds if Issues Persist

If images still don't load:

1. **Check MinIO is accessible**: Ensure `http://localhost:9000` is reachable from the frontend
2. **Verify bucket policy**: Bucket should allow GetObject operations
3. **Check CORS**: MinIO should allow requests from frontend origin (though presigned URLs bypass CORS)
4. **Compare URLs**: Generate a presigned URL with Python backend and compare with TypeScript

## Environment Variables

Ensure these are set correctly in `.env`:

```bash
NEUROAGENT_STORAGE__ENDPOINT_URL="http://localhost:9000"
NEUROAGENT_STORAGE__ACCESS_KEY="minioadmin"
NEUROAGENT_STORAGE__SECRET_KEY="minioadmin"
NEUROAGENT_STORAGE__BUCKET_NAME="neuroagent"
NEUROAGENT_STORAGE__EXPIRES_IN="3600"
```

## Related Files

- `backend-ts/src/lib/storage/client.ts` - S3 client configuration
- `backend-ts/src/app/api/storage/[file_identifier]/presigned-url/route.ts` - Presigned URL generation
- `backend-ts/src/lib/tools/thumbnail_generation/storage.ts` - File upload utility
- `backend-ts/src/lib/tools/thumbnail_generation/plot-*.ts` - Thumbnail generation tools

## References

- [MinIO GitHub Discussion #14709](https://github.com/minio/minio/discussions/14709) - AWS SDK v3 signature mismatch
- [AWS SDK v3 S3 Request Presigner](https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/Package/-aws-sdk-s3-request-presigner/)
- [MinIO JavaScript SDK Documentation](https://docs.min.io/enterprise/aistor-object-store/developers/sdk/javascript/)
