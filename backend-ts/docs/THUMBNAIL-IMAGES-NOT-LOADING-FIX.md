# Thumbnail Images Not Loading - Troubleshooting Guide

## Issue

Thumbnail images generated by the TypeScript backend are not displaying in the frontend, even though the tool execution succeeds and returns a `storage_id`.

## Checklist

### 1. Verify Tool Response Format

The tool must return `storage_id` (snake_case) to match frontend expectations:

```typescript
return { storage_id: storageId };  // ✓ Correct
return { storageId: storageId };   // ✗ Wrong - frontend won't find it
```

**Status**: ✓ Verified - TypeScript tools return `storage_id` correctly

### 2. Verify Storage Path Format

Files must be stored with the correct path format: `{userId}/{identifier}`

**Python implementation**:
```python
filename = "/".join([str(user_id), identifier])
```

**TypeScript implementation**:
```typescript
const filename = `${userId}/${identifier}`;
```

**Status**: ✓ Verified - Both use the same format

### 3. Verify Presigned URL Generation

The presigned URL endpoint must:
- Accept GET requests at `/api/storage/{file_identifier}/presigned-url`
- Construct the S3 key as `{userId}/{file_identifier}`
- Return the presigned URL as plain text (not JSON)
- Include proper CORS headers

**Status**: ✓ Verified - TypeScript endpoint matches Python

### 4. Check MinIO CORS Configuration

MinIO must be configured to allow CORS requests from the frontend domain.

**To check MinIO CORS**:
```bash
# Connect to MinIO container
docker exec -it neuroagent-minio-1 mc alias set myminio http://minio:9000 minioadmin minioadmin

# Check current CORS configuration
docker exec -it neuroagent-minio-1 mc anonymous get-json myminio/neuroagent

# Set CORS policy
docker exec -it neuroagent-minio-1 mc anonymous set-json myminio/neuroagent <<EOF
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {"AWS": ["*"]},
      "Action": ["s3:GetObject"],
      "Resource": ["arn:aws:s3:::neuroagent/*"]
    }
  ]
}
EOF
```

**Alternative: Set CORS via MinIO Console**:
1. Open MinIO console at http://localhost:9001
2. Login with minioadmin/minioadmin
3. Go to Buckets → neuroagent → Access Rules
4. Set bucket policy to allow public read access

### 5. Verify S3 Client Configuration

The S3 client must be configured with:
- Correct endpoint URL
- Valid credentials
- `forcePathStyle: true` for MinIO compatibility

**Check environment variables**:
```bash
# In backend-ts/.env
NEUROAGENT_STORAGE__ENDPOINT_URL="http://localhost:9000"
NEUROAGENT_STORAGE__ACCESS_KEY="minioadmin"
NEUROAGENT_STORAGE__SECRET_KEY="minioadmin"
NEUROAGENT_STORAGE__BUCKET_NAME="neuroagent"
NEUROAGENT_STORAGE__EXPIRES_IN="3600"
```

**Status**: ✓ Fixed - Environment variables now use correct naming

### 6. Check Browser Console for Errors

Common errors:
- **CORS error**: MinIO CORS not configured
- **403 Forbidden**: Bucket policy doesn't allow access
- **404 Not Found**: File not uploaded or wrong path
- **Network error**: MinIO not accessible from frontend

### 7. Verify File Upload

Check if files are actually being uploaded to MinIO:

```bash
# List files in bucket
docker exec -it neuroagent-minio-1 mc ls myminio/neuroagent/

# List files for a specific user
docker exec -it neuroagent-minio-1 mc ls myminio/neuroagent/{user-id}/
```

### 8. Test Presigned URL Directly

1. Get a storage_id from a tool response
2. Call the presigned URL endpoint directly:
   ```bash
   curl -H "Authorization: Bearer YOUR_JWT_TOKEN" \
     http://localhost:3000/api/storage/{storage_id}/presigned-url
   ```
3. Copy the returned URL and open it in a browser
4. The image should display

### 9. Compare with Python Backend

If images work with Python backend but not TypeScript:

1. Generate an image with Python backend
2. Note the storage_id
3. Get presigned URL from Python: `GET http://localhost:8078/storage/{storage_id}/presigned-url`
4. Get presigned URL from TypeScript: `GET http://localhost:3000/api/storage/{storage_id}/presigned-url`
5. Compare the URLs - they should be identical except for the host

## Common Issues and Solutions

### Issue: CORS Error in Browser Console

**Symptom**:
```
Access to fetch at 'http://localhost:9000/...' from origin 'http://localhost:3001'
has been blocked by CORS policy
```

**Solution**: Configure MinIO CORS (see step 4 above)

### Issue: 403 Forbidden

**Symptom**: Presigned URL returns 403 Forbidden

**Solution**:
1. Check bucket policy allows GetObject
2. Verify credentials are correct
3. Ensure file exists at the correct path

### Issue: Images Load from Python but not TypeScript

**Symptom**: Same storage_id works with Python backend but not TypeScript

**Solution**:
1. Compare presigned URLs from both backends
2. Check if TypeScript is using correct bucket name
3. Verify S3 client configuration matches Python

### Issue: Thread ID Undefined Error

**Symptom**: `GET http://localhost:3000/threads/undefined 500`

**Solution**: This is a frontend issue, not related to thumbnail generation. The frontend is trying to fetch a thread before the thread_id is available. Check frontend state management.

## Debugging Steps

1. **Enable verbose logging**:
   ```typescript
   // In backend-ts/src/lib/tools/thumbnail_generation/storage.ts
   console.log('Saving to storage:', {
     bucket: bucketName,
     key: filename,
     contentType,
     metadata
   });
   ```

2. **Log presigned URL generation**:
   ```typescript
   // In backend-ts/src/app/api/storage/[file_identifier]/presigned-url/route.ts
   console.log('Generating presigned URL for:', {
     bucket: settings.storage.bucketName,
     key,
     expiresIn: settings.storage.expiresIn
   });
   console.log('Generated URL:', presignedUrl);
   ```

3. **Check MinIO logs**:
   ```bash
   docker logs neuroagent-minio-1
   ```

4. **Test S3 connection**:
   ```bash
   # In backend-ts directory
   npx tsx -e "
   import { getS3Client } from './src/lib/storage/client.ts';
   import { ListBucketsCommand } from '@aws-sdk/client-s3';
   const client = getS3Client();
   const result = await client.send(new ListBucketsCommand({}));
   console.log('Buckets:', result.Buckets);
   "
   ```

## Expected Behavior

1. User asks to plot a morphology or electrical recording
2. Tool executes and uploads image to MinIO at `{userId}/{uuid}.png`
3. Tool returns `{ storage_id: "uuid" }`
4. Frontend extracts `storage_id` from tool result
5. Frontend calls `/api/storage/{storage_id}/presigned-url`
6. Backend generates presigned URL for `{userId}/{storage_id}`
7. Frontend fetches image from presigned URL
8. Image displays in chat

## Next Steps

If images still don't load after following this guide:

1. Capture network traffic to see exact requests/responses
2. Compare byte-for-byte with Python backend behavior
3. Check if MinIO version matches between Python and TypeScript environments
4. Verify frontend is using the correct backend URL
