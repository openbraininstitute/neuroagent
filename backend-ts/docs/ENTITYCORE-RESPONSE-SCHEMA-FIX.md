# EntityCore Response Schema and Zod Default Values Fix

## Issues

### Issue 1: Response Schema Mismatch

The EntityCore tools were failing with Zod validation errors when parsing API responses:

```
Error executing tool entitycore-brainregion-getall: [
  {"code": "invalid_type","expected": "array","received": "undefined","path": ["items"],"message": "Required"},
  {"code": "invalid_type","expected": "number","received": "undefined","path": ["total"],"message": "Required"},
  ...
]
```

### Issue 2: OpenAI Function Schema Validation Error

After fixing the response schema, OpenAI rejected the function schema:

```
Invalid schema for function 'entitycore-brainregion-getall': 
In context=(), 'required' is required to be supplied and to be an array 
including every key in properties. Missing 'page'.
```

## Root Causes

### Cause 1: Incorrect Response Schema

The TypeScript implementation had an incorrect response schema that didn't match the actual EntityCore API response format.

**Incorrect Schema (TypeScript):**
```typescript
{
  items: array,
  total: number,
  page: number,
  page_size: number,
  pages: number
}
```

**Actual API Response (from Python backend):**
```typescript
{
  data: array,
  pagination: {
    page: number,
    page_size: number,
    total_items: number
  },
  facets?: object
}
```

### Cause 2: Incorrect Zod Default Pattern

The code was using `.optional().default()` for fields with default values, which causes issues with OpenAI's function calling API. The Vercel AI SDK's `tool()` function expects fields with defaults to use `.default()` WITHOUT `.optional()`.

**Incorrect Pattern:**
```typescript
page: z.number().int().min(1).optional().default(1)
```

**Correct Pattern:**
```typescript
page: z.number().int().min(1).default(1)
```

This matches the Python backend pattern where Pydantic's `Field(default=...)` automatically makes fields optional in the JSON schema without explicit `Optional` typing.

## Solutions

### Solution 1: Updated Response Schema

Updated `EntityCoreListResponseSchema` in `backend-ts/src/lib/tools/entitycore/base.ts` to match the actual API response structure from the Python backend.

**Changes Made:**

1. **Created `EntityCorePaginationResponseSchema`:**
   ```typescript
   export const EntityCorePaginationResponseSchema = z.object({
     page: z.number().int(),
     page_size: z.number().int(),
     total_items: z.number().int(),
   });
   ```

2. **Updated `EntityCoreListResponseSchema`:**
   ```typescript
   export const EntityCoreListResponseSchema = <T extends z.ZodType>(itemSchema: T) =>
     z.object({
       data: z.array(itemSchema),
       pagination: EntityCorePaginationResponseSchema,
       facets: z.record(z.unknown()).optional(),
     });
   ```

### Solution 2: Fixed Zod Default Pattern

Removed `.optional()` from all fields that use `.default()` across all tools:

**Files Updated:**
- `backend-ts/src/lib/tools/entitycore/base.ts` - EntityCorePaginationSchema
- `backend-ts/src/lib/tools/entitycore/brain-region-getall.ts` - hierarchy_id field
- `backend-ts/src/lib/tools/example-tool.ts` - maxResults, includeMetadata
- `backend-ts/src/lib/tools/literature-search.ts` - num_results
- `backend-ts/src/lib/tools/web-search.ts` - num_results
- `backend-ts/src/lib/tools/obione/circuit-metrics-getone.ts` - level_of_detail fields

**Pattern Applied:**
```typescript
// Before (incorrect)
field: z.type().optional().default(value)

// After (correct)
field: z.type().default(value)
```

### Affected Tools

The following tools automatically inherit the fixes:
- `BrainRegionGetAllTool` - Response schema + default pattern
- `CellMorphologyGetAllTool` - Response schema
- `LiteratureSearchTool` - Default pattern
- `WebSearchTool` - Default pattern
- `CircuitMetricsGetOneTool` - Default pattern
- `ExampleTool` - Default pattern

All other EntityCore tools that use `EntityCoreListResponseSchema` will also benefit from the response schema fix.

## Reference

### Python Backend Patterns

The correct patterns are defined in the Python backend:

**Response Structure:**
- `backend/src/neuroagent/tools/autogenerated_types/entitycore.py`
  - `ListResponseBrainRegionRead` class
  - `PaginationResponse` class

**Default Values:**
- `backend/src/neuroagent/tools/entitycore_brainregion_getall.py`
  - Uses `Field(default=...)` without `Optional`
  - Pydantic automatically makes fields with defaults optional in JSON schema

## Translation Note

This fix ensures feature parity with the Python backend by:
1. Matching the actual EntityCore API response format
2. Following the same pattern for optional fields with defaults

When translating Python backend code to TypeScript:
- Verify API response structures against Python autogenerated types
- Use `.default()` WITHOUT `.optional()` for fields with default values (matches Pydantic's `Field(default=...)`)
- Let the Vercel AI SDK's `tool()` function handle schema conversion for OpenAI

## Testing

- Type checking passes: `npm run type-check`
- Build succeeds: `npm run build`
- No breaking changes to existing code (types are inferred from schemas)

## Date

January 26, 2026
