# Autogenerated Types: Discriminated Union Bug - RESOLVED ✅

## Status: FIXED

**Resolution Date**: February 2026
**Solution**: Migrated from `openapi-zod-client` to `@hey-api/openapi-ts`

The discriminated union bug that existed in `openapi-zod-client` has been **completely resolved** by switching to `@hey-api/openapi-ts` with the Zod plugin.

---

## Historical Issue (Now Fixed)

This document is kept for historical reference. The issue no longer affects the codebase.

### The Original Problem

The autogenerated EntityCore types file previously contained a discriminated union that failed at module load time due to a bug in the `openapi-zod-client` code generator.

**Location**: Line 951 in old `entitycore.ts`

```typescript
// ❌ OLD - openapi-zod-client (BROKEN)
const NestedCellMorphologyProtocolRead = z.discriminatedUnion('generation_type', [
  NestedDigitalReconstructionCellMorphologyProtocolRead,  // Had z.string()
  NestedModifiedReconstructionCellMorphologyProtocolRead,
  NestedComputationallySynthesizedCellMorphologyProtocolRead,
  NestedPlaceholderCellMorphologyProtocolRead,
]);
```

**Error**:
```
A discriminator value for key `generation_type` could not be extracted from all schema options
```

### Root Cause

The EntityCore OpenAPI spec defined discriminator fields using `const`:

```json
{
  "properties": {
    "generation_type": {
      "type": "string",
      "const": "digital_reconstruction"
    }
  }
}
```

However, `openapi-zod-client` incorrectly generated:

```typescript
generation_type: z.string()  // ❌ Wrong - should be z.literal('digital_reconstruction')
```

---

## The Solution: @hey-api/openapi-ts ✅

### What Changed

We migrated from `openapi-zod-client` to `@hey-api/openapi-ts` which correctly handles OpenAPI `const` values:

```typescript
// ✅ NEW - @hey-api/openapi-ts (WORKS!)
export const zNestedCellMorphologyProtocolRead = z.union([
  z.object({
    generation_type: z.literal('digital_reconstruction')  // ✅ Correct!
  }).and(zNestedDigitalReconstructionCellMorphologyProtocolRead),
  z.object({
    generation_type: z.literal('modified_reconstruction')
  }).and(zNestedModifiedReconstructionCellMorphologyProtocolRead),
  z.object({
    generation_type: z.literal('computationally_synthesized')
  }).and(zNestedComputationallySynthesizedCellMorphologyProtocolRead),
  z.object({
    generation_type: z.literal('placeholder')
  }).and(zNestedPlaceholderCellMorphologyProtocolRead)
]);
```

### Benefits

1. **No workarounds needed** - Direct imports work perfectly
2. **Better type safety** - Literal types provide exact discrimination
3. **Cleaner code** - No dynamic imports required
4. **Production-ready** - Used by Vercel, PayPal, and other major companies
5. **Better maintenance** - Active development and comprehensive documentation

---

## Migration Details

### Old Workaround (No Longer Needed)

Previously, we used dynamic imports to defer schema evaluation:

```typescript
// ❌ OLD WORKAROUND - No longer needed!
async execute(input: z.infer<typeof InputSchema>): Promise<unknown> {
  // Dynamically import to avoid module-load time schema evaluation
  const { createApiClient } = await import('../autogenerated_types/entitycore');
  const client = createApiClient(entitycoreUrl);
  // ...
}
```

### New Implementation (Current)

Now we can use direct imports:

```typescript
// ✅ NEW - Direct imports work!
import { zBrainRegionRead, type BrainRegionRead } from '../autogenerated_types/entitycore.ts/zod.gen';

async execute(input: z.infer<typeof InputSchema>): Promise<BrainRegionRead> {
  // Direct usage, no dynamic imports needed
  const data = await fetchData();
  const validated = zBrainRegionRead.parse(data);
  return validated;
}
```

---

## Generation Command

To regenerate the EntityCore types:

```bash
npx @hey-api/openapi-ts \
  -i https://staging.openbraininstitute.org/api/entitycore/openapi.json \
  -o ./src/lib/tools/autogenerated_types/entitycore.ts \
  -c @hey-api/client-fetch
```

Or use the configuration file (recommended):

```typescript
// openapi-ts.config.ts
import { defineConfig } from '@hey-api/openapi-ts';

export default defineConfig({
  client: '@hey-api/client-fetch',
  input: 'https://staging.openbraininstitute.org/api/entitycore/openapi.json',
  output: {
    path: './src/lib/tools/autogenerated_types/entitycore.ts',
    format: 'prettier',
  },
  plugins: [
    {
      name: '@hey-api/schemas',
      type: 'zod',
    },
    '@hey-api/sdk',
    '@hey-api/types',
  ],
});
```

Then run:
```bash
npm run generate:entitycore
```

---

## Testing

All tools using the generated schemas have been tested and verified:

```bash
npm test -- brain-region-tools.test.ts
```

**Result**: ✅ 13/13 tests passing

---

## References

- [hey-api/openapi-ts Documentation](https://heyapi.vercel.app/)
- [Original openapi-zod-client Issue #326](https://github.com/astahmer/openapi-zod-client/issues/326)
- [Migration Guide](./OPENAPI-ZOD-GENERATOR-ALTERNATIVES.md)
- [Zod Documentation](https://zod.dev/)

---

## For Future Tool Implementations

When implementing new EntityCore tools:

1. **Import schemas directly** from `zod.gen.ts`:
   ```typescript
   import { zYourSchema, type YourType } from '../autogenerated_types/entitycore.ts/zod.gen';
   ```

2. **Use Zod validation** in execute methods:
   ```typescript
   const validated = zYourSchema.parse(data);
   ```

3. **Type your returns** with generated types:
   ```typescript
   async execute(input: InputType): Promise<YourType> {
     // ...
   }
   ```

4. **No workarounds needed** - The discriminated union bug is fixed!

---

**Last Updated**: February 2026
**Status**: ✅ Resolved
