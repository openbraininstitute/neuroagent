# Single Neuron Simulation GetAll Tool Translation

**Date:** 2025-01-XX
**Status:** ✅ Complete
**Source:** `backend/src/neuroagent/tools/entitycore_singleneuronsimulation_getall.py`
**Target:** `backend-ts/src/lib/tools/entitycore/single-neuron-simulation-getall.ts`

## Summary

Successfully translated the EntityCore Single Neuron Simulation GetAll tool from Python to TypeScript, following the established patterns for EntityCore tools in the TypeScript backend.

## Implementation Details

### Files Created

1. **Tool Implementation**
   - `backend-ts/src/lib/tools/entitycore/single-neuron-simulation-getall.ts`
   - Implements `SingleNeuronSimulationGetAllTool` class
   - Extends `BaseTool` with EntityCore context variables
   - Uses autogenerated Zod schemas for validation

2. **Test Suite**
   - `backend-ts/src/lib/tools/entitycore/__tests__/single-neuron-simulation-tools.test.ts`
   - Tests for both GetAll and GetOne tools
   - 17 test cases covering metadata, validation, and functionality

### Files Modified

1. **Tool Registry** (`backend-ts/src/lib/tools/index.ts`)
   - Added export for `single-neuron-simulation-getall`
   - Registered tool class in `registerToolClasses()`
   - Added tool instantiation in `createToolInstance()`
   - Added tool class to `getAvailableToolClasses()`

## Key Features

### Input Schema

The tool accepts the following parameters:

- **page_size**: Number of items per page (1-10, default: 5)
- **within_brain_region_brain_region_id**: UUID of brain region to filter by (optional)
- **within_brain_region_direction**: Direction for brain region hierarchy search
  - `ascendants`: Search parent regions
  - `descendants`: Search child regions
  - `ascendants_and_descendants`: Search both (default)
- All standard EntityCore query parameters from autogenerated schema

### Functionality

1. **Brain Region Hierarchy Lookup**
   - When `within_brain_region_brain_region_id` is provided, fetches the hierarchy_id
   - Adds hierarchy_id to query parameters for hierarchical filtering

2. **Response Modification**
   - Sets `assets` to empty array for each simulation
   - Adds `url_link` field: `{entityFrontendUrl}/{simulation.id}`

3. **Error Handling**
   - HTTPError handling with detailed error messages
   - Validates brain region endpoint responses
   - Validates simulation endpoint responses

### Static Methods

- **isOnline()**: Health check method that pings EntityCore `/health` endpoint

## Translation Patterns

### Python → TypeScript Equivalents

| Python | TypeScript |
|--------|-----------|
| `ClassVar[str]` | `static readonly` |
| `async def arun()` | `async execute()` |
| `@classmethod async def is_online()` | `static async isOnline()` |
| Pydantic `BaseModel` | Zod schema with `.extend()` |
| `model_dump(exclude_defaults=True)` | Manual object iteration |
| `httpx_client.get()` | `httpClient.get()` (ky) |
| `response.json()` | `.json<T>()` with type |

### Schema Customization

The input schema extends the autogenerated schema with:

```typescript
const SingleNeuronSimulationGetAllInputSchema =
  zReadManySingleNeuronSimulationGetData.shape.query
    .unwrap() // Remove optional wrapper
    .extend({
      page_size: z.number().int().gte(1).lte(10).default(5),
      within_brain_region_direction: z.enum([...]).default('ascendants_and_descendants'),
      within_brain_region_brain_region_id: z.string().uuid().optional(),
    });
```

## Testing

All tests pass successfully:

```bash
✓ Single Neuron Simulation Tools (17)
  ✓ SingleNeuronSimulationGetAllTool (9)
    ✓ should have correct metadata
    ✓ should instantiate with context variables
    ✓ should have valid input schema
    ✓ should validate page_size constraints
    ✓ should validate within_brain_region_direction enum
    ✓ should validate UUID format for brain region ID
    ✓ should have default values
    ✓ should convert to Vercel tool format
    ✓ should have isOnline static method
  ✓ Tool Registration (1)
  ✓ SingleNeuronSimulationGetOneTool (7)
```

## Integration

The tool is fully integrated into the tool system:

1. ✅ Exported from `backend-ts/src/lib/tools/index.ts`
2. ✅ Registered in `registerToolClasses()`
3. ✅ Instantiation logic in `createToolInstance()`
4. ✅ Available in `getAvailableToolClasses()` when EntityCore URL is configured
5. ✅ Test suite validates all functionality

## Usage Example

```typescript
import { SingleNeuronSimulationGetAllTool } from '@/lib/tools';

const tool = new SingleNeuronSimulationGetAllTool({
  httpClient: kyInstance,
  entitycoreUrl: 'https://api.entitycore.example.com',
  entityFrontendUrl: 'https://entitycore.example.com',
  vlabId: 'virtual-lab-uuid',
  projectId: 'project-uuid',
});

const result = await tool.execute({
  page_size: 5,
  within_brain_region_brain_region_id: 'brain-region-uuid',
  within_brain_region_direction: 'ascendants_and_descendants',
});
```

## Notes

- Follows the exact pattern established by `simulation-campaign-getall.ts`
- Uses autogenerated Zod schemas from `entitycore/zod.gen.ts`
- Maintains feature parity with Python implementation
- Properly handles brain region hierarchy lookups
- Sets assets to empty array and adds url_link as per Python behavior
- All error messages match Python implementation format

## Related Files

- Python source: `backend/src/neuroagent/tools/entitycore_singleneuronsimulation_getall.py`
- TypeScript implementation: `backend-ts/src/lib/tools/entitycore/single-neuron-simulation-getall.ts`
- Test file: `backend-ts/src/lib/tools/entitycore/__tests__/single-neuron-simulation-tools.test.ts`
- Tool registry: `backend-ts/src/lib/tools/index.ts`
- Zod schemas: `backend-ts/src/lib/tools/autogenerated_types/entitycore/zod.gen.ts`
