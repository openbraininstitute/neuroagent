# OpenAI Strict Mode Solution for Generate Simulations Config Tool

## Problem Summary

The `obione-generatesimulationsconfig` tool was failing with `NoObjectGeneratedError: response did not match schema` when using OpenAI's structured outputs with strict mode.

## Root Cause Analysis

### 1. Autogenerated Schema Issues
The autogenerated Zod schemas from `@hey-api/openapi-ts` have two critical problems for strict mode:

**Problem A: `.and()` creates `allOf`**
```typescript
z.union([
  z.object({ type: z.literal('SingleTimestamp') }).and(zSingleTimestamp),
  z.object({ type: z.literal('RegularTimestamps') }).and(zRegularTimestamps)
])
```
This creates `allOf` in JSON Schema, which is **not supported in OpenAI's strict mode**.

**Problem B: `.optional()` is not supported**
```typescript
timestamps: z.record(TimestampUnion).optional()
```
Strict mode requires all fields to be in the `required` array - `.optional()` is not allowed.

### 2. Strict Mode Requirements

From Vercel AI SDK documentation:
> "OpenAI structured outputs have several limitations, in particular around the supported schemas. For example, optional schema properties are not supported. You need to change Zod .nullish() and .optional() to .nullable()."

**Key constraints:**
- **No `allOf`, `oneOf` at root level** (only `anyOf` is partially supported)
- **No `.optional()` fields** - all fields must be required
- **Use `.nullable()` for optional fields** - but field must be present (can be `null`, not `undefined`)
- **Use `.nullable().default(null)` for truly optional fields** - allows omission, defaults to `null`

### 3. Critical Distinction: `.nullable()` vs `.nullable().default(null)`

**`.nullable()` alone:**
- Field MUST be present in response
- Can be `null` but NOT `undefined`
- If model omits field → `undefined` → validation fails ❌

**`.nullable().default(null)`:**
- Field CAN be omitted from response
- Missing fields default to `null` instead of `undefined`
- If model omits field → `null` → validation succeeds ✅

### 4. Python vs TypeScript Behavior

**Python implementation:**
- Uses `beta.chat.completions.parse()` which **automatically normalizes schemas to strict mode**
- Pydantic's optional fields are automatically converted appropriately
- `SkipJsonSchema` excludes fields from the schema entirely

**TypeScript implementation:**
- Vercel AI SDK enables strict mode by default for OpenAI
- We must manually transform schemas to be compatible
- No automatic normalization happens

## Solution Implemented

### Approach: Dynamic Schema Transformation

Created a recursive transformation function that makes schemas strict-mode compatible without modifying autogenerated files.

### 1. Schema Transformation Function

```typescript
function makeOptionalFieldsNullable(schema: z.ZodTypeAny): z.ZodTypeAny {
  // .optional() → .nullable().default(null)
  // Allows field to be omitted, defaults to null
  if (schema instanceof z.ZodOptional) {
    const unwrapped = schema.unwrap();
    const transformed = makeOptionalFieldsNullable(unwrapped);
    return transformed.nullable().default(null);
  }

  // .nullable() → .nullable() (no default)
  // Field must be present, can be null
  if (schema instanceof z.ZodNullable) {
    const unwrapped = (schema as any)._def.innerType;
    const transformed = makeOptionalFieldsNullable(unwrapped);
    return transformed.nullable();
  }

  // .default(value) → .default(value) (keep existing)
  if (schema instanceof z.ZodDefault) {
    const innerSchema = (schema as any)._def.innerType;
    const defaultValue = (schema as any)._def.defaultValue();
    const transformed = makeOptionalFieldsNullable(innerSchema);
    return transformed.default(defaultValue);
  }

  // .and() → merge object shapes (flatten allOf)
  if (schema instanceof z.ZodIntersection) {
    const left = (schema as any)._def.left;
    const right = (schema as any)._def.right;
    const transformedLeft = makeOptionalFieldsNullable(left);
    const transformedRight = makeOptionalFieldsNullable(right);

    if (transformedLeft instanceof z.ZodObject && transformedRight instanceof z.ZodObject) {
      const mergedShape = { ...transformedLeft.shape, ...transformedRight.shape };
      return z.object(mergedShape);
    }
    return transformedRight;
  }

  // Recursively process objects, unions, records, arrays
  // ... (handles nested structures)
}
```

### 2. Apply Transformation

```typescript
const CircuitSimulationScanConfigModifiedSchema = makeOptionalFieldsNullable(
  zCircuitSimulationScanConfig.extend({
    initialize: InitializeNoCircuitSchema,
  })
) as z.ZodType<any>;
```

### 3. Use with Vercel AI SDK

```typescript
const result = await generateObject({
  model: openaiClient(model),
  schema: CircuitSimulationScanConfigModifiedSchema,
  schemaName: 'CircuitSimulationScanConfig',
  schemaDescription: 'Circuit simulation configuration',
  messages: [
    { role: 'system', content: systemPrompt },
    { role: 'user', content: userMessage },
  ],
  // Strict mode is enabled by default for OpenAI
});
```

### 4. Filter Null Values in Output

Since the schema uses nullable fields but the output type expects non-null, we filter nulls:

```typescript
const filterNulls = (obj: any): any => {
  if (obj === null || obj === undefined) return undefined;
  if (Array.isArray(obj)) return obj.map(filterNulls).filter(v => v !== undefined && v !== null);
  if (typeof obj === 'object') {
    const filtered: Record<string, any> = {};
    for (const [key, value] of Object.entries(obj)) {
      const filteredValue = filterNulls(value);
      if (filteredValue !== undefined && filteredValue !== null) {
        filtered[key] = filteredValue;
      }
    }
    return filtered;
  }
  return obj;
};
```

## Transformation Rules

| Input Schema | Transformation | Reason |
|--------------|----------------|--------|
| `.optional()` | `.nullable().default(null)` | Allows omission, defaults to null |
| `.nullable()` | `.nullable()` (unchanged) | Field must be present, can be null |
| `.default(value)` | `.default(value)` (unchanged) | Keep existing defaults |
| `.and()` (ZodIntersection) | Merge object shapes | Avoid `allOf` in JSON schema |
| Nested structures | Recursive transformation | Ensure entire tree is compatible |

## Key Learnings

### 1. Vercel AI SDK Strict Mode
- **Enabled by default** for OpenAI models
- No need to specify `mode` or `strictJsonSchema` parameters
- Automatically uses OpenAI's structured outputs API

### 2. Schema Compatibility
**Strict Mode Compatible:**
- ✅ `.nullable()` - field present, can be null
- ✅ `.nullable().default(null)` - field can be omitted
- ✅ Simple unions with `z.union()`
- ✅ Merged object shapes

**Strict Mode Incompatible:**
- ❌ `.optional()` - not supported
- ❌ `.nullish()` - not supported
- ❌ `.and()` creating `allOf` - not supported
- ❌ `oneOf` at root level - not supported

### 3. Why Not Modify Autogenerated Files
The autogenerated schemas in `autogenerated_types/obione/zod.gen.ts` should not be modified because:
1. They're regenerated from OpenAPI specs
2. Changes would be overwritten on next generation
3. Other tools may rely on the original schema structure
4. Dynamic transformation is more maintainable

## Alternative Approaches Considered

### 1. ❌ Disable Strict Mode
```typescript
providerOptions: {
  openai: { strictJsonSchema: false }
}
```
**Rejected:** User explicitly required strict mode for 100% schema adherence guarantee.

### 2. ❌ Switch to OpenAI SDK Directly
```typescript
import OpenAI from 'openai';
import { zodResponseFormat } from 'openai/helpers/zod';
```
**Rejected:** User requested to stay with Vercel AI SDK for consistency with codebase.

### 3. ❌ Manually Redefine All Schemas
Rewrite all discriminated unions without `.and()`.
**Rejected:** Too invasive, transformation handles it automatically.

### 4. ✅ Dynamic Schema Transformation (Chosen)
Recursively transform schemas at runtime.
**Accepted:**
- Minimal code changes
- Doesn't modify autogenerated files
- Handles all edge cases
- Maintains Python parity
- Keeps strict mode enabled

## Debugging Tips

### Enhanced Error Logging
```typescript
if (NoObjectGeneratedError.isInstance(error)) {
  console.error('NoObjectGeneratedError details:');
  console.error('  Cause:', error.cause);
  console.error('  Text:', error.text);
  console.error('  Response:', JSON.stringify(error.response, null, 2));
  console.error('  Usage:', error.usage);
  console.error('  Finish Reason:', error.finishReason);
}
```

### Common Error Patterns
- `"expected": "object", "received": "undefined"` → Field omitted by model, needs `.default(null)`
- `"expected": "null", "received": "undefined"` → Field omitted by model, needs `.default(null)`
- `allOf is not permitted` → Need to flatten `.and()` intersections
- `optional fields not supported` → Need to convert `.optional()` to `.nullable()`

## Testing Recommendations

1. **Test with actual circuit IDs** to verify end-to-end functionality
2. **Verify token consumption tracking** is properly updated
3. **Test various config requests**:
   - Creating new configurations from scratch
   - Modifying existing configurations
   - Edge cases with null/undefined values
4. **Monitor validation errors** with enhanced logging
5. **Verify output filtering** removes null values correctly

## Future Considerations

If other tools encounter similar strict mode errors:
1. Apply the same `makeOptionalFieldsNullable()` transformation
2. Ensure all `.optional()` fields are converted
3. Flatten any `.and()` intersections
4. Add `.default(null)` for truly optional fields
5. Filter nulls in output if needed

## References

- [Vercel AI SDK - OpenAI Provider](https://sdk.vercel.ai/providers/ai-sdk-providers/openai)
- [Vercel AI SDK - Structured Outputs](https://sdk.vercel.ai/docs/ai-sdk-core/generating-structured-data)
- [Vercel AI SDK - No Object Generated Error](https://sdk.vercel.ai/docs/troubleshooting/no-object-generated-content-filter)
- [OpenAI Structured Outputs Guide](https://platform.openai.com/docs/guides/structured-outputs)
- [OpenAI Structured Outputs Limitations](https://platform.openai.com/docs/guides/structured-outputs#supported-schemas)

## Implementation Files

- **TypeScript Tool:** `backend-ts/src/lib/tools/obione/generate-simulations-config.ts`
- **Python Reference:** `backend/src/neuroagent/tools/obione_generatesimulationsconfig.py`
- **Autogenerated Schemas:** `backend-ts/src/lib/tools/autogenerated_types/obione/zod.gen.ts`
