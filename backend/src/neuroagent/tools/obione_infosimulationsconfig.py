"""Tool to answer questions about the simulation config schema."""

import json
from typing import ClassVar

from openai import AsyncOpenAI
from pydantic import BaseModel, Field

from neuroagent.tools.autogenerated_types.obione import CircuitSimulationScanConfig
from neuroagent.tools.base_tool import BaseMetadata, BaseTool
from neuroagent.utils import get_token_count


class InfoSimulationsConfigInput(BaseModel):
    """Inputs of the InfoSimulationsConfig tool."""

    question: str = Field(
        description="A question about the simulation configuration schema."
    )


class InfoSimulationsConfigOutput(BaseModel):
    """Output of the InfoSimulationsConfig tool."""

    answer: str


class InfoSimulationsConfigMetadata(BaseMetadata):
    """Metadata of the InfoSimulationsConfig tool."""

    openai_client: AsyncOpenAI
    token_consumption: dict[str, str | int | None] | None = None


class InfoSimulationsConfigTool(BaseTool):
    """Class defining the InfoSimulationsConfig tool."""

    name: ClassVar[str] = "obione-infosimulationsconfig"
    name_frontend: ClassVar[str] = "Info Simulation Config"
    utterances: ClassVar[list[str]] = [
        "What does this field mean",
        "Explain the simulation config",
        "How do I configure stimuli",
    ]
    description: ClassVar[str] = (
        "Answers questions about the CircuitSimulationScanConfig schema. "
        "Use this when users ask what certain fields mean or how to configure simulations."
    )
    description_frontend: ClassVar[str] = (
        "Ask questions about the simulation configuration schema."
    )
    metadata: InfoSimulationsConfigMetadata
    input_schema: InfoSimulationsConfigInput

    async def arun(self) -> InfoSimulationsConfigOutput:
        """Run the tool."""
        schema_json = json.dumps(
            CircuitSimulationScanConfig.model_json_schema(), indent=2
        )

        system_prompt = f"""You are an expert on the CircuitSimulationScanConfig schema used for neuroscience simulations.
Answer questions about what different fields mean, how to use them, and best practices.

Here is the full JSON schema:

{schema_json}

Be concise and helpful. If a field has nested structures, explain the hierarchy."""

        model = "gpt-4o"
        response = await self.metadata.openai_client.chat.completions.create(
            model=model,
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": self.input_schema.question},
            ],
        )

        answer = response.choices[0].message.content or ""

        token_consumption = get_token_count(response.usage)
        self.metadata.token_consumption = {**token_consumption, "model": model}

        return InfoSimulationsConfigOutput(answer=answer)

    @classmethod
    async def is_online(cls) -> bool:
        """Check if the tool is online."""
        return True
