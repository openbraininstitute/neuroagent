"""Get One Electrical Cell Recording Thumbnail tool."""

from typing import Any, ClassVar
from uuid import UUID

from httpx import AsyncClient
from pydantic import BaseModel, Field

from neuroagent.tools.autogenerated_types.thumbnail_generation import (
    GetEphysPreviewApiThumbnailGenerationCoreElectricalCellRecordingPreviewGetParametersQuery,
)
from neuroagent.tools.base_tool import BaseMetadata, BaseTool
from neuroagent.utils import save_to_storage


class PlotElectricalCellRecordingGetOneInput(
    GetEphysPreviewApiThumbnailGenerationCoreElectricalCellRecordingPreviewGetParametersQuery
):
    """Input of the PlotElectricalCellRecording."""

    asset_id: UUID = Field(
        description="ID of the asset. You need to call the `entitycore-electricalcellrecording-getall`, `entitycore-electricalcellrecording-getone` or the `entitycore-asset-getall` tool on the relevant electrical cell recording beforehand to get this parameter. The ID must always come from the `nwb` asset, which is indicated by the `'content_type': 'application/nwb'`."
    )


class PlotElectricalCellRecordingGetOneMetadata(BaseMetadata):
    """Metadata class for the thumbnail generation of electrical cell recordings."""

    httpx_client: AsyncClient
    thumbnail_generation_url: str
    s3_client: Any  # boto3 client
    user_id: UUID
    bucket_name: str
    thread_id: UUID
    vlab_id: UUID | None
    project_id: UUID | None


class PlotElectricalCellRecordingGetOneOutput(BaseModel):
    """Output of the PlotElectricalCellRecordingGetOneTool."""

    storage_id: str


class PlotElectricalCellRecordingGetOneTool(BaseTool):
    """Class defining the Get One ElectricalCellRecording Thumbnail logic."""

    name: ClassVar[str] = "thumbnail-generation-electricalcellrecording-getone"
    name_frontend: ClassVar[str] = "Get Electrical Cell Recording Thumbnail"
    utterances: ClassVar[list[str]] = [
        "Create a visual representation",
        "Generate a thumbnail for this electrical cell recording",
        "Show me a visualization of this electrical cell recording",
        "Find a trace in the isocortex and plot it.",
        "Plot the following trace.",
        "Generate a thumbnail for this trace",
    ]
    description: ClassVar[str] = """**Purpose**:
        Generate a visual representation of a specified electrical cell recording.

        **When to Call**:
        When the user asks to plot a electrical cell recording (trace) or requests more information about it.

        **Inputs**:
        entity_id: ID of the target entity.
        asset_id: ID of the specific electricalcellrecording asset. Retrieve using `entitycore-electricalcellrecording-getall`, `entitycore-electricalcellrecording-getone` or `entitycore-asset-getall`.

        **Output**:
        storage_id: Identifier for where the generated plot is stored.

        **Notes**:
        Do not embed or display the plot link directly in your response.
    """
    description_frontend: ClassVar[
        str
    ] = """Plot the electrical cell recording of your choice to display a thumbnail in the chat.

    Use this tool to enhance the description of your target electrical cell recording by adding visuals."""
    metadata: PlotElectricalCellRecordingGetOneMetadata
    input_schema: PlotElectricalCellRecordingGetOneInput

    async def arun(self) -> PlotElectricalCellRecordingGetOneOutput:
        """From an Entity ID and an Asset ID, plot the visual of the electrical cell recording.

        Returns
        -------
            storage_id which locates the plot in the storage.
        """
        headers: dict[str, str] = {}
        if self.metadata.vlab_id is not None:
            headers["virtual-lab-id"] = str(self.metadata.vlab_id)
        if self.metadata.project_id is not None:
            headers["project-id"] = str(self.metadata.project_id)

        response = await self.metadata.httpx_client.get(
            url=self.metadata.thumbnail_generation_url.rstrip("/")
            + "/core/electrical-cell-recording/preview",
            headers=headers,
            params=self.input_schema.model_dump(exclude_defaults=True, mode="json"),
        )
        if response.status_code != 200:
            raise ValueError(
                f"The Electrical Cell Recording Thumbnail endpoint returned a non 200 response code. Error: {response.text}"
            )

        # Save to storage
        identifier = save_to_storage(
            s3_client=self.metadata.s3_client,
            bucket_name=self.metadata.bucket_name,
            user_id=self.metadata.user_id,
            content_type="image/png",
            category="image",
            body=response.content,
            thread_id=self.metadata.thread_id,
        )

        return PlotElectricalCellRecordingGetOneOutput(storage_id=identifier)

    @classmethod
    async def is_online(
        cls, *, httpx_client: AsyncClient, thumbnail_generation_url: str
    ) -> bool:
        """Check if the tool is online."""
        response = await httpx_client.get(
            f"{thumbnail_generation_url.rstrip('/')}/health",
        )
        return response.status_code == 200
