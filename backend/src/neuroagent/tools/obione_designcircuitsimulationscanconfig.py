"""Tool to design an obi-one compatible simulation config."""

import json
from typing import Any, ClassVar
from urllib.parse import urlparse
from uuid import UUID

from httpx import AsyncClient
from openai import AsyncOpenAI
from pydantic import BaseModel, Field
from pydantic.json_schema import SkipJsonSchema

from neuroagent.app.app_utils import extract_frontend_context
from neuroagent.new_types import SharedState
from neuroagent.tools.autogenerated_types.obione import (
    CircuitFromID,
    CircuitSimulationScanConfig,
    ObiOneScientificTasksGenerateSimulationConfigsCircuitSimulationScanConfigInitialize,
)
from neuroagent.tools.base_tool import BaseMetadata, BaseTool
from neuroagent.utils import get_token_count


def extract_model_structure(model: type[BaseModel]) -> dict[str, Any]:
    """Recursively extract nested field structure from a Pydantic model."""
    result = {}
    for name, field_info in model.model_fields.items():
        field_type = field_info.annotation

        if isinstance(field_type, type) and issubclass(field_type, BaseModel):
            result[name] = extract_model_structure(field_type)
        else:
            result[name] = {}

    return result


class DesignSimulationsConfigInput(BaseModel):
    """Inputs of the DesignSimulationsConfig tool."""

    circuit_id: UUID | None = Field(
        default=None,
        description="UUID of the target circuit that has to be simulated. ONLY CIRCUITS CAN BE SIMULATED. NO OTHER ENTITY. Specify it only if you are sure about which circuit must be simulated. Otherwise it will be infered from the app state.",
    )
    config_request: str = Field(
        description="A detailed description of the desired simulation configuration that will be processed by an LLM to produce JSON. This should contain either: (1) a complete specification for a new configuration including all required parameters and settings, or (2) specific modifications to be applied to an existing configuration (e.g., 'change simulation length to 5000ms', 'Apply an extra stimulus for excitatory neurons', 'record only inhibitory neurons instead'). Be explicit about which approach you're using and provide clear, actionable details."
    )


class DesignSimulationsConfigMetadata(BaseMetadata):
    """Metadata of the DesignSimulationsConfig tool."""

    openai_client: AsyncOpenAI
    httpx_client: AsyncClient
    obi_one_url: str
    vlab_id: UUID | None
    project_id: UUID | None
    shared_state: SharedState
    current_frontend_url: str | None = None
    token_consumption: dict[str, str | int | None] | None = None
    request_id: str | None = None


class InitializeNoCircuit(
    ObiOneScientificTasksGenerateSimulationConfigsCircuitSimulationScanConfigInitialize
):
    """Simulation Initialize block without reference to the circuit."""

    circuit: SkipJsonSchema[None] = Field(default=None, title="Circuit", exclude=True)  # type: ignore


class CircuitSimulationScanConfigModified(CircuitSimulationScanConfig):
    """Simulations form that redefines certain attributes."""

    initialize: InitializeNoCircuit = Field(
        ...,
        description="Parameters for initializing the simulation.",
        title="Initialization",
    )


class DesignSimulationConfigOutput(BaseModel):
    """Output of the DesignSimulationsConfig tool."""

    smc_simulation_config: CircuitSimulationScanConfig
    url_link: str | None = None


class DesignSimulationsConfigTool(BaseTool):
    """Class defining the DesignSimulationsConfig tool."""

    name: ClassVar[str] = "obione-designcircuitsimulationscanconfig"
    name_frontend: ClassVar[str] = "Design Circuit Simulation Config"
    utterances: ClassVar[list[str]] = [
        "Create a simulation configuration",
        "Design a config for me",
        "Set up simulation parameters",
    ]
    description: ClassVar[str] = f"""# Role and Objective
This tool designs JSON configurations for CIRCUIT simulations based on natural language descriptions. Only CIRCUIT simulations are supported; do not attempt to process other ENTITY types.

# Instructions
- Accept as input either a comprehensive new configuration description or incremental modifications to an existing configuration.
- For new simulations, only provide a circuit ID if the user explicitly specifies it; otherwise, let the application state infer the circuit ID.
- For modification requests, support focused/incremental descriptions relative to the existing configuration. Users do not need to provide the full target configuration.
- If a request is vague, design a basic simulation config and offer guidance on further refinement. Do not force users to provide all parameters. Defaults are handled by the underlying LLM.
- In the `config_request` parameter, only include what the user explicitly requested. Exclude default or standard parameters, as they will be filled in automatically by the downstream LLM.
- Here are the available fields in the simulation ford {extract_model_structure(CircuitSimulationScanConfig)}. Base your description in `config_request` on them.
- If the user is not on a circuit-related page, and has not mentioned any circuit previously, ask the user for clarification to ensure the request is intended for a CIRCUIT simulation before proceeding.

# Output Format
- Output: Valid simulation configuration JSON (produced by the tool; NEVER display this directly in chat).
- Summarize the simulation setup and scenario concisely, focusing on the main changes or intent, not on listing each parameter or the full JSON structure.
- Indicate clearly that the designed simulation JSON is a suggestion. Encourage users to modify it as needed.
- If a `url_link` field is present, guide the user to the simulation page unless they are already viewing it (no action required if `url_link` is None).

# Use Cases
Call this tool whenever users:
- Want to create new CIRCUIT simulation configurations.
- Need to modify or tweak existing configurations.
- Request conversion of requirements to structured CIRCUIT JSON.

# Constraints
- Only support CIRCUIT simulations; do not handle other entities.
- Never produce the simulation JSON yourself if the tool fails.
- Do not show, copy, or enumerate the raw JSON output in chat.

# Verbosity
- Provide concise, high-level summaries clearly stating the overall setup and nature of each simulation.

# Future features (currently unsupported)
- Users might still ask for particular features which have not yet been implemented. If they are listed here, you can tell them they are planned for future.
- In future, the user will be able to record voltage from any location in neurons, and also specify extracellular recordings.
"""
    description_frontend: ClassVar[
        str
    ] = """Create or modify JSON configurations using natural language.
Simply specify in plain english what you want your configuration to achieve or what changes you'd like to make."""
    metadata: DesignSimulationsConfigMetadata
    input_schema: DesignSimulationsConfigInput

    async def arun(self) -> DesignSimulationConfigOutput:
        """Run the tool."""
        # Check for existing state passed by frontend
        if not self.metadata.shared_state:
            raise ValueError(
                "A state with key `smc_simulation_config` must be provided in the request body to trigger this tool."
            )
        base_simulation_form = self.metadata.shared_state.smc_simulation_config
        if not base_simulation_form:
            raise ValueError(
                "An SMC simulation form must be provided in the state when calling this tool."
            )

        try:
            circuit_id = self.input_schema.circuit_id or UUID(
                base_simulation_form.get("initialize", {})
                .get("circuit", {})
                .get("id_str")
            )
        except (ValueError, TypeError):
            circuit_id = None
        if not circuit_id:
            raise ValueError(
                "A circuit ID must be provided either in the tool input or in the state. Please validate for which circuit we must design a simulation config."
            )

        # Get the available nodesest in the circuit
        headers: dict[str, str] = {}
        if self.metadata.vlab_id is not None:
            headers["virtual-lab-id"] = str(self.metadata.vlab_id)
        if self.metadata.project_id is not None:
            headers["project-id"] = str(self.metadata.project_id)

        circuit_node_set = await self.metadata.httpx_client.get(
            self.metadata.obi_one_url.rstrip("/")
            + f"/declared/circuit/{self.input_schema.circuit_id}/nodesets",
            headers=headers,
        )
        nodesets = (
            circuit_node_set.json() if circuit_node_set.status_code == 200 else None
        )

        # List obi-one rules
        system_prompt = f"""# Simulation Configuration Designer

You are an expert at producing valid JSON simulation configurations following the CircuitSimulationScanConfig schema.
You will receive two inputs:
1. A description of the required configuration changes or specifications
2. The current simulation configuration JSON (either a default/empty config or an existing one)

## Task Approach
You are always modifying the provided configuration. The nature of modifications depends on the starting point:
- **Starting from default config**: User requests typically describe complete simulation requirements ("Design a simulation with X neurons for Y duration")
- **Starting from existing config**: User requests typically describe incremental changes ("Add stimulus X", "Set parameter Y to Z")

Apply the requested changes to the provided configuration, replacing or adding elements as needed.

## Info
- Fill the title and description in the "info" block with human readable text based on the overall simulation scenario. Summarize the main intent and setup of the simulation in a concise manner.
- Do not leave title and description empty.
- If the existing title and description describe the scenario well and the user request is only about a specific parameter change, you can keep them as they are.

## Timestamps and Stimuli Logic
- **Only create timestamps if stimuli will use them**
- Choose stimulus type based on timing pattern:
  - **Single timestamp + MultiPulse**: For repeated pulses at one timepoint
  - **Multiple timestamps + single-pulse stimulus**: For stimuli at different timepoints
  - **Never combine MultiPulse with repetitive timestamps**
- Modify existing timing logic only when specifically requested

## Recordings
- Existing recording options are for somatic voltages.
- Spike times of all neurons in the simulation are recorded by default so there is no need to specify recording blocks unless the user asks for voltage recordings or you think the particular use case requires it.

## Parameter Values
- Use single values, not single-element lists (e.g., `"duration": 500.0` not `"duration": [500.0]`)
- Lists indicate parameter sweeps - only use when scanning multiple values
- For IDNeuronSet, include meaningful number of neurons (typically 50+ for populations)
- Update only the parameters mentioned in the modification request

## Modification Guidelines
- **Comprehensive requests** (from default configs): Build out the full simulation as described, replacing default values
- **Incremental requests** (from existing configs): Make targeted changes while preserving unmodified elements
- "Add X" means include X alongside existing elements (unless it conflicts)
- "Remove" or "delete" means eliminate the specified element entirely
- "Set" or "change" means replace the specified parameter with the new value
- When building from defaults, interpret requests as comprehensive specifications rather than additions

## Neuron Sets and References
- Create neuron sets in the "neuron_sets" dictionary with meaningful keys
- **Only create neuron sets that will actually be used**
- For references (NeuronSetReference, TimestampsReference):
  - `block_name`: the dictionary key (e.g., "all_neurons")
  - `block_dict_name`: the parent dictionary name (e.g., "neuron_sets", "timestamps")
- Avoid duplicate or unused neuron sets unless specifically requested
- {f"Whenever you see a `circuit_property_type = CircuitNodeSet` in the schema of the neuron_sets you want to use, the string value within `node_set` must be one of the following: {nodesets}" if nodesets is not None else ""}
- Usage of PredefinedNeuronSets should be avoided where possible. Prefer using other neuron set types.

## Validation Checklist
Before outputting, verify:
- [ ] All references use existing dictionary keys with correct block_dict_name
- [ ] No unused neuron sets or timestamps
- [ ] Stimulus timing logic is coherent
- [ ] No single-element lists unless intentional parameter sweep
- [ ] Requested changes are accurately applied to the provided configuration
- [ ] Configuration structure remains valid and consistent

Produce only the JSON configuration, ensuring all references are internally consistent.
"""  # nosec B608

        user_message = f"""
CURRENT SIMULATION CONFIG JSON:
{json.dumps(base_simulation_form)}

REQUIREMENTS:
{self.input_schema.config_request}
"""

        model = "gpt-5-mini"
        # Then produce the global class and make the according references
        response = await self.metadata.openai_client.beta.chat.completions.parse(
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_message},
            ],
            model=model,
            reasoning_effort="low",
            response_format=CircuitSimulationScanConfigModified,
        )
        if response.choices[0].message.parsed:
            # Get the output config
            config = response.choices[0].message.parsed

            # Gather everything in the OBI-One compatible class
            output_config = CircuitSimulationScanConfig(
                type="CircuitSimulationScanConfig",
                timestamps=config.timestamps or {},
                stimuli=config.stimuli or {},
                recordings=config.recordings or {},
                neuron_sets=config.neuron_sets or {},
                synaptic_manipulations=config.synaptic_manipulations or {},
                initialize=ObiOneScientificTasksGenerateSimulationConfigsCircuitSimulationScanConfigInitialize(
                    circuit=CircuitFromID(
                        id_str=str(self.input_schema.circuit_id), type="CircuitFromID"
                    ),
                    **config.initialize.model_dump(),
                ),
                info=config.info,
            )

            # Assign token usage
            token_consumption = get_token_count(response.usage)
            self.metadata.token_consumption = {**token_consumption, "model": model}

        else:
            raise ValueError("Couldn't produce a valid simulation config.")

        if not self.metadata.current_frontend_url:
            url_link = None
        else:
            parsed = urlparse(self.metadata.current_frontend_url)
            parts = parsed.path.split("/")
            # Expect: ['', 'app', 'virtual-lab', 'vlab-id', 'project-id', ...]
            if len(parts) >= 5 and parts[1:3] == ["app", "virtual-lab"]:
                base_path = "/".join(parts[:5])
                url_link = (
                    f"{parsed.scheme}://{parsed.netloc}{base_path}/workflows/simulate/configure/circuit/{circuit_id}"
                    if not self.is_correct_simulation_page(
                        self.metadata.current_frontend_url, circuit_id
                    )
                    else None
                )
                if url_link and self.metadata.request_id:
                    url_link += f"?x-request-id={self.metadata.request_id}"
            else:
                url_link = None

        return DesignSimulationConfigOutput(
            smc_simulation_config=ts_number_normalize(output_config), url_link=url_link
        )

    @classmethod
    async def is_online(cls) -> bool:
        """Check if the tool is online."""
        return True

    @staticmethod
    def is_correct_simulation_page(
        url: str | None = None, circuit_id: UUID | None = None
    ) -> bool:
        """We are on the simulation page if the url contains /workflows/simulate/configure/circuit and `panel=configuration`."""
        if not url:
            return False

        if "/workflows/simulate/configure/circuit" not in url:
            return False

        if "panel=" not in url:
            return True

        if "panel=configuration" not in url:
            return False

        if circuit_id:
            context = extract_frontend_context(url)
            if context.current_entity_id and circuit_id != context.current_entity_id:
                return False

        return True


def ts_number_normalize(value: Any) -> Any:
    """Cast python json to ts json."""
    if isinstance(value, float):
        return int(value) if value.is_integer() else value
    if isinstance(value, list):
        return [ts_number_normalize(v) for v in value]
    if isinstance(value, dict):
        return {k: ts_number_normalize(v) for k, v in value.items()}
    return value
