"""BlueNaaS single cell stimulation, simulation and synapse placement tool."""

import logging
from typing import ClassVar

from httpx import AsyncClient
from pydantic.json_schema import SkipJsonSchema

from neuroagent.tools.autogenerated_types.bluenaas.models import (
    PaginatedResponseUnionMEModelResponseSynaptomeModelResponse,
)
from neuroagent.tools.autogenerated_types.bluenaas.schemas import (
    RetrieveNeuronModelsApiBluenaasNeuronModelVirtualLabIdProjectIdMeModelsGetParams,
)
from neuroagent.tools.base_tool import BaseMetadata, BaseTool

logger = logging.getLogger(__name__)


class InputMEModelGetAll(
    RetrieveNeuronModelsApiBluenaasNeuronModelVirtualLabIdProjectIdMeModelsGetParams
):
    """Inputs for the BlueNaaS single-neuron simulation."""

    virtual_lab_id: SkipJsonSchema[str] = "placeholder"
    project_id: SkipJsonSchema[str] = "placeholder"


class MEModelGetAllMetadata(BaseMetadata):
    """Metadata class for the get all me models api."""

    token: str
    vlab_id: str
    project_id: str
    bluenaas_url: str


class MEModelGetAllToolOutput(
    PaginatedResponseUnionMEModelResponseSynaptomeModelResponse
):
    """Rebranding."""


class MEModelGetAllTool(BaseTool):
    """Class defining the MEModelGetAll tool."""

    name: ClassVar[str] = "memodelgetall-tool"
    name_frontend: ClassVar[str] = "Get All ME Models"
    description: ClassVar[str] = """Get multiple me models from the user.
    Returns `page_size` ME-models that belong to the user's project.
    If the user requests an ME-model with specific criteria, use this tool
    to retrieve multiple of its ME-models and chose yourself the one(s) that fit the user's request."""
    description_frontend: ClassVar[
        str
    ] = """Browse through available neuron models in your project. This tool helps you:
    • List all your neuron models
    • Find models by type (single-neuron or synaptome)
    • Navigate through multiple models using pagination

    The tool returns a list of models with their metadata and properties."""
    metadata: MEModelGetAllMetadata
    input_schema: InputMEModelGetAll

    async def arun(self) -> MEModelGetAllToolOutput:
        """Run the MEModelGetAll tool."""
        logger.info(
            f"Running MEModelGetAll tool with inputs {self.input_schema.model_dump()}"
        )

        params = RetrieveNeuronModelsApiBluenaasNeuronModelVirtualLabIdProjectIdMeModelsGetParams(
            virtual_lab_id=self.metadata.vlab_id,
            project_id=self.metadata.project_id,
            offset=self.input_schema.offset,
            page_size=self.input_schema.page_size,
            model_type=self.input_schema.model_type,
            created_at_start=self.input_schema.created_at_start,
            created_at_end=self.input_schema.created_at_end,
        )
        response = await self.metadata.httpx_client.get(
            url=f"{self.metadata.bluenaas_url}/neuron-model/{params.virtual_lab_id}/{params.project_id}/me-models",
            params=params.model_dump(
                exclude_defaults=True, exclude={"virtual_lab_id", "project_id"}
            ),
            headers={"Authorization": f"Bearer {self.metadata.token}"},
        )

        return MEModelGetAllToolOutput(**response.json())

    @classmethod
    async def is_online(cls, *, httpx_client: AsyncClient, bluenaas_url: str) -> bool:
        """Check if the tool is online."""
        response = await httpx_client.get(
            bluenaas_url,
        )
        return response.status_code == 200
