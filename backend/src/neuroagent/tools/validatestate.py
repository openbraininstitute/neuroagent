"""Tool to validate the shared state."""

from typing import ClassVar, Literal

from pydantic import BaseModel

from neuroagent.new_types import SharedState
from neuroagent.tools.autogenerated_types.obione import CircuitSimulationScanConfig
from neuroagent.tools.base_tool import BaseMetadata, BaseTool


class ValidateStateInput(BaseModel):
    """Input schema for the ValidateState tool."""

    pass  # No input needed


class ValidateStateMetadata(BaseMetadata):
    """Metadata for the ValidateState tool."""

    shared_state: SharedState


class ValidateStateOutput(BaseModel):
    """Output of the ValidateState tool."""

    is_valid: Literal[True] = True


class ValidateStateTool(BaseTool):
    """Class defining the ValidateState tool."""

    name: ClassVar[str] = "validatestate"
    name_frontend: ClassVar[str] = "Validate State"
    utterances: ClassVar[list[str]] = [
        "Check if the configuration is valid",
        "Validate the state",
        "Is this configuration correct?",
    ]
    description: ClassVar[str] = """Validates the shared application state.

Call this after `editstate` or whenever you think the state should be valid.

Returns success message if valid, raises error if invalid.
If invalid, use the error traceback to correct the state with the `editstate` tool."""
    description_frontend: ClassVar[str] = """Validate the application state."""
    metadata: ValidateStateMetadata
    input_schema: ValidateStateInput

    async def arun(self) -> ValidateStateOutput:
        """Validate the shared state."""
        if not self.metadata.shared_state:
            raise ValueError("No shared state provided.")

        state = self.metadata.shared_state.model_dump()

        # Validate smc_simulation_config if present
        if state.get("smc_simulation_config"):
            CircuitSimulationScanConfig(**state["smc_simulation_config"])

        return ValidateStateOutput(message="State is valid")

    @classmethod
    async def is_online(cls) -> bool:
        """Check if the tool is online."""
        return True
