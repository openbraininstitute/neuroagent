"""Tool to generate an obi-one compatible simulation config."""

from typing import Any, ClassVar
from uuid import UUID

from httpx import AsyncClient
from openai import AsyncOpenAI
from pydantic import BaseModel, Field
from pydantic.json_schema import SkipJsonSchema

from neuroagent.tools.autogenerated_types.obione import (
    CircuitFromID,
    ObiOneScientificUnionsAliasesSimulationsFormInitialize,
    SimulationsForm,
)
from neuroagent.tools.base_tool import BaseMetadata, BaseTool
from neuroagent.utils import get_token_count


def extract_model_structure(model: type[BaseModel]) -> dict[str, Any]:
    """Recursively extract nested field structure from a Pydantic model."""
    result = {}
    for name, field_info in model.model_fields.items():
        field_type = field_info.annotation

        if isinstance(field_type, type) and issubclass(field_type, BaseModel):
            result[name] = extract_model_structure(field_type)
        else:
            result[name] = {}

    return result


class GenerateSimulationsConfigInput(BaseModel):
    """Inputs of the GenerateSimulationsConfig tool."""

    circuit_id: UUID = Field(
        description="UUID of the target circuit that has to be simulated."
    )
    config_request: str = Field(
        description="A natural language description of what the user wants in their simulation configuration. Only specify what the user explicitly requested - defaults and standard parameters will be handled automatically by the downstream LLM. The output will always be valid JSON, so no need to request JSON format."
    )


class GenerateSimulationsConfigMetadata(BaseMetadata):
    """Metadata of the GenerateSimulationsConfig tool."""

    openai_client: AsyncOpenAI
    httpx_client: AsyncClient
    obi_one_url: str
    vlab_id: UUID | None
    project_id: UUID | None
    token_consumption: dict[str, str | int | None] | None = None


class InitializeNoCircuit(ObiOneScientificUnionsAliasesSimulationsFormInitialize):
    """Simulation Initialize block without reference to the circuit."""

    circuit: SkipJsonSchema[None] = Field(default=None, title="Circuit", exclude=True)  # type: ignore


class SimulationsFormModified(SimulationsForm):
    """Simulations form that redefines certain attributes."""

    initialize: InitializeNoCircuit = Field(
        ...,
        description="Parameters for initializing the simulation.",
        title="Initialization",
    )


class GenerateSimulationsConfigTool(BaseTool):
    """Class defining the GenerateSimulationsConfig tool."""

    name: ClassVar[str] = "obione-generatesimulationsconfig"
    name_frontend: ClassVar[str] = "Generate Simulation Config"
    utterances: ClassVar[list[str]] = [
        "Create a simulation configuration",
        "Generate a config for me",
        "Set up simulation parameters",
    ]
    description: ClassVar[
        str
    ] = f"""This tool generates valid JSON configurations for simulations from natural language descriptions.

Always use a circuit ID with this tool. If you can't see a reference to an existing circuit in the chat, ask for clarifications.

IMPORTANT: In the config_request parameter, only describe what the user explicitly requested. Do NOT include default values or standard parameters - the downstream LLM will handle those automatically. The output will always be valid JSON.
The downstream LLM uses structured output. It has a lot of information about the structure and defaults of the simulations form.

Available configuration fields: {extract_model_structure(SimulationsForm)}

Use this tool when users need to:
- Create new simulation configurations
- Modify existing configurations
- Specify simulation parameters

Always call this tool to generate a simulation config, never attempt to generate one yourself.
Do not try to generate a simulation config yourself if the tool fails.
    """
    description_frontend: ClassVar[
        str
    ] = """Create or modify JSON configurations using natural language.
Simply specify in plain english what you want your configuration to achieve or what changes you'd like to make."""
    metadata: GenerateSimulationsConfigMetadata
    input_schema: GenerateSimulationsConfigInput

    async def arun(self) -> SimulationsForm:
        """Run the tool."""
        # Get the available nodesest in the circuit
        headers: dict[str, str] = {}
        if self.metadata.vlab_id is not None:
            headers["virtual-lab-id"] = str(self.metadata.vlab_id)
        if self.metadata.project_id is not None:
            headers["project-id"] = str(self.metadata.project_id)

        circuit_node_set = await self.metadata.httpx_client.get(
            self.metadata.obi_one_url.rstrip("/")
            + f"/declared/circuit/{self.input_schema.circuit_id}/nodesets",
            headers=headers,
        )
        if circuit_node_set.status_code != 200:
            raise ValueError(
                f"The nodesets endpoint returned a non 200 response code. Error: {circuit_node_set.text}"
            )
        system_prompt = f"""# Simulation Configuration Generator

You are an expert at generating valid JSON simulation configurations following the SimulationsForm schema.
The description of the required configuration is going to be the first `user` message you receive.
To generate a meaningful simulation config, follow these critical rules:

## Timestamps and Stimuli Logic
- **Only generate timestamps if stimuli will use them**
- Choose stimulus type based on timing pattern:
  - **Single timestamp + MultiPulse**: For repeated pulses at one timepoint
  - **Multiple timestamps + single-pulse stimulus**: For stimuli at different timepoints
  - **Never combine MultiPulse with repetitive timestamps**

## Parameter Values
- Use single values, not single-element lists (e.g., `"duration": 500.0` not `"duration": [500.0]`)
- Lists indicate parameter sweeps - only use when scanning multiple values
- For IDNeuronSet, include meaningful number of neurons (typically 50+ for populations)

## Neuron Sets and References
- Generate neuron sets in the "neuron_sets" dictionary with meaningful keys
- **Only create neuron sets that will actually be used**
- For references (NeuronSetReference, TimestampsReference):
  - `block_name`: the dictionary key (e.g., "all_neurons")
  - `block_dict_name`: the parent dictionary name (e.g., "neuron_sets", "timestamps")
- Avoid duplicate or unused neuron sets unless specifically requested
- Whenever you see a `circuit_property_type = CircuitNodeSet` in the schema of the neuron_sets you want to use, the string value within `node_set` must be one of the following: {circuit_node_set.json()}


## Validation Checklist
Before outputting, verify:
- [ ] All references use existing dictionary keys with correct block_dict_name
- [ ] No unused neuron sets or timestamps
- [ ] Stimulus timing logic is coherent
- [ ] No single-element lists unless intentional parameter sweep

Generate only the JSON configuration, ensuring all references are internally consistent.
"""
        model = "gpt-5-mini"
        # Then generate the global class and make the according references
        response = await self.metadata.openai_client.beta.chat.completions.parse(
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": self.input_schema.config_request},
            ],
            model=model,
            reasoning_effort="medium",
            response_format=SimulationsFormModified,
        )
        if response.choices[0].message.parsed:
            # Get the output config
            config = response.choices[0].message.parsed

            # Gather everything in the OBI-One compatible class
            output_config = SimulationsForm(
                type="SimulationsForm",
                timestamps=config.timestamps or {},
                stimuli=config.stimuli or {},
                recordings=config.recordings or {},
                neuron_sets=config.neuron_sets or {},
                synaptic_manipulations=config.synaptic_manipulations or {},
                initialize=ObiOneScientificUnionsAliasesSimulationsFormInitialize(
                    circuit=CircuitFromID(
                        id_str=str(self.input_schema.circuit_id), type="CircuitFromID"
                    ),
                    **config.initialize.model_dump(),
                ),
                info=config.info,
            )

            # Assign token usage
            token_consumption = get_token_count(response.usage)
            self.metadata.token_consumption = {**token_consumption, "model": model}
        else:
            raise ValueError("Couldn't generate a valid simulation config.")
        return output_config

    @classmethod
    async def is_online(cls) -> bool:
        """Check if the tool is online."""
        return True
