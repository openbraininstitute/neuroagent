FROM python:3.11

ENV PYTHONUNBUFFERED=1

RUN apt-get -y update && \
    apt-get -y install curl \
    ca-certificates \
    build-essential \
    libhdf5-dev \
    libboost-all-dev \
    ninja-build \
    nodejs \
    npm \
    wget \
    && rm -rf /var/lib/apt/lists/*

# Install cmake (with special handling for ARM)
RUN TARGETARCH=$(dpkg --print-architecture) && \
    if [ "$TARGETARCH" = "arm64" ] || [ "$TARGETARCH" = "aarch64" ]; then \
        wget https://github.com/Kitware/CMake/archive/refs/tags/v4.0.1.tar.gz -O cmake.tar.gz && \
        tar xzf cmake.tar.gz && \
        cd CMake-4.0.1 && \
        ./bootstrap --parallel=$(nproc) && \
        make -j$(nproc) && \
        make install && \
        cd .. && \
        rm -rf CMake-4.0.1 cmake.tar.gz; \
    else \
        apt-get update && apt-get install -y cmake && rm -rf /var/lib/apt/lists/*; \
    fi

ENV CMAKE=/usr/local/bin/cmake
ENV CMAKE_POLICY_VERSION_MINIMUM=3.5
RUN which cmake && cmake --version

# Install deno
RUN npm install -g deno@">=2.5.0"

# Install uv using the official installer script
ADD https://astral.sh/uv/install.sh /uv-installer.sh
RUN sh /uv-installer.sh && rm /uv-installer.sh
ENV PATH="/root/.local/bin/:$PATH"

COPY ./ /code
WORKDIR /code

# Install dependencies using uv with tasks extra
RUN uv sync --extra tasks

# Download manual wheels
RUN mkdir -p cached_wheels && \
    uv pip download --only-binary=:all: --no-deps -d ./cached_wheels plotly

WORKDIR /code

# Celery worker entrypoint
# Celery app is configured in neuroagent.tasks.main
ENTRYPOINT ["uv", "run", "celery", "-A", "neuroagent.tasks.main", "worker", "--loglevel=info"]
