name: Check DeepEval
on:
  pull_request:
    branches: [ main ]

jobs:
  Check-DeepEval:
    name: Check DeepEval
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check if overall_results.json was updated
        run: |
          BASE_BRANCH=${GITHUB_BASE_REF:-main}
          
          if git diff --quiet origin/$BASE_BRANCH...HEAD -- backend/eval/aggregate/overall_results.json; then
            echo "❌ overall_results.json was not updated in this PR!"
            echo "Please run the evaluation script to update the results."
            exit 1
          else
            echo "✅ overall_results.json has been updated"
          fi
      
      - name: Install Python dependencies
        run: |
          cd backend
          python -m pip install --upgrade pip
          pip install pandas httpx deepeval python-dotenv pydantic colorama
      
      - name: Compare evaluation results with main branch
        run: |
          BASE_BRANCH=${GITHUB_BASE_REF:-main}
          
          # Check if main branch has overall_results.json
          if git show origin/$BASE_BRANCH:backend/eval/aggregate/overall_results.json > /dev/null 2>&1; then
            echo "📊 Comparing evaluation results with main branch..."
            
            # Get the main branch version
            git show origin/$BASE_BRANCH:backend/eval/aggregate/overall_results.json > main_results.json
            
            # Run comparison
            cd backend
            python src/neuroagent/scripts/compare_results.py ../main_results.json eval/aggregate/overall_results.json
          else
            echo "📊 No previous results found on main branch, showing current results:"
            cd backend
            python src/neuroagent/scripts/compare_results.py eval/aggregate/overall_results.json
          fi
