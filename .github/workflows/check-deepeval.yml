name: Check DeepEval
on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  Check-DeepEval:
    name: Check DeepEval
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check if scores.json was updated (PR only)
        if: github.event_name == 'pull_request'
        run: |
          BASE_BRANCH=${GITHUB_BASE_REF:-main}
          
          if git diff --quiet origin/$BASE_BRANCH...HEAD -- backend/eval/output/scores.json; then
            echo "❌ scores.json was not updated in this PR!"
            echo "Please run the evaluation script to update the results."
            echo "python -m neuroagent.scripts.evaluate_agent  $TOKEN"
            exit 1
          else
            echo "✅ scores.json has been updated"
          fi
      
      - name: Install Python dependencies
        run: |
          cd backend
          python -m pip install --upgrade pip
          pip install pandas httpx deepeval python-dotenv pydantic colorama
      
      - name: Show evaluation results
        env:
          PY_COLORS: '1'
          FORCE_COLOR: '1'
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_BRANCH=${GITHUB_BASE_REF:-main}
            
            # Check if main branch has scores.json
            if git show origin/$BASE_BRANCH:backend/eval/output/scores.json > /dev/null 2>&1; then
              echo "📊 Comparing evaluation results with main branch..."
              
              # Get the main branch version
              git show origin/$BASE_BRANCH:backend/eval/output/scores.json > main_results.json
              
              # Run comparison
              cd backend
              python src/neuroagent/scripts/compare_results.py ../main_results.json eval/output/scores.json
            else
              echo "📊 No previous results found on main branch, showing current results:"
              cd backend
              python src/neuroagent/scripts/compare_results.py eval/output/scores.json
            fi
          else
            echo "📊 Showing current evaluation results:"
            cd backend
            python src/neuroagent/scripts/compare_results.py eval/output/scores.json
          fi
